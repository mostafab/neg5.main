"use strict";!function(){angular.module("tournamentApp",["ngCookies","ngAnimate","statsApp"]).config(["$animateProvider",function(e){e.classNameFilter(/angular-animate/)}])}(),function(){angular.module("HomeApp",["ngCookies","ngAnimate"]).config(["$animateProvider",function(e){e.classNameFilter(/angular-animate/)}]),angular.module("HomeApp").controller("HomeController",["$cookies","$scope","$http","$timeout","$window",function(e,n,t,a,o){var s=this;n.toastMessage=null;var r=3e3,u=null;n.toast=function(e){var t=e.message,o=e.success,s=void 0===o?null:o,i=e.hideAfter,c=void 0!==i&&i;c&&(u&&a.cancel(u),u=a(function(){n.toastMessage=null,u=null},r)),n.toastMessage={message:t,success:s}},s.tournaments=[],s.submittingForm=!1,s.getTournaments=function(){var n=e.get("nfToken");t.get("/api/t?token="+n).then(function(e){var n=e.data;s.tournaments=n.data}).catch(function(e){return console.log(e)})},s.createNewTournament=function(){s.newTournamentForm.$valid&&!function(){var a={token:e.get("nfToken"),name:s.newTournament.name},o={message:"Adding tournament: "+s.newTournament.name};n.toast(o),s.submittingForm=!0,t.post("/api/t",a).then(function(e){var n=e.data,t=n.result.tournament;s.getTournaments(),s.newTournament={},o.success=!0,o.message="Added tournament: "+t.name}).catch(function(e){o.success=!1,o.message="Could not add tournament."}).finally(function(){o.hideAfter=!0,s.submittingForm=!1,n.toast(o)})}()},s.newTournament={},n.logout=function(){e.remove("nfToken"),o.location="/"},s.getTournaments()}])}(),function(){angular.module("IndexApp",["ngCookies","ngAnimate"]).config(["$animateProvider",function(e){e.classNameFilter(/angular-animate/)}]),angular.module("IndexApp").controller("IndexController",["$cookies","$scope","$http","$timeout",function(e,n,t,a){var o=this;o.loggingIn=!0,o.user={username:"",password:""},o.newUser={name:"",email:"",username:"",password:"",passwordConfirm:""},o.toastMessage=null,o.toast=function(e){var n=e.message,t=e.success,s=void 0===t?null:t,r=e.hideAfter,u=void 0!==r&&r;u&&a(function(){o.toastMessage=null},2500),o.toastMessage={message:n,success:s}},o.login=function(){n.loginForm.$valid&&!function(){var n={message:"Attempting to log in"};o.toast(n),t.post("/api/account/authenticate",o.user).then(function(t){var a=t.data,o=a.token;e.put("nfToken",o),n.success=!0,n.message="Taking you to home page.",window.location="/tournaments"}).catch(function(e){n.success=!1,n.message="Invalid credentials.",n.hideAfter=!0}).finally(function(){return o.toast(n)})}()},o.register=function(){n.registrationForm.$valid&&o.newUser.password===o.newUser.passwordConfirm&&!function(){var e={message:"Attempting to register."};o.toast(e),t.post("/api/account",o.newUser).then(function(t){t.data;o.user={username:o.newUser.username,password:o.newUser.password},e.message="Logging you in.",e.success=!0,o.toast(e),n.loginForm.$valid=!0,o.login()}).catch(function(n){e.message="Could not register. This username or email might be taken.",e.success=!1,e.hideAfter=!0,o.toast(e)})}()},o.googleLogin=function(){t.get("/auth/google").then(function(e){var n=e.data;console.log(n)})}}])}(),function(){function e(e,t,a,o,s,r){var u=this,i=n(t);u.toastMessage=null,u.phases=o.phases,u.divisions=s.divisions,u.unassignedTeams=s.unassignedTeams,u.phase=null,u.playerStats=s.playerStats,u.teamStats=s.teamStats,u.teamFullStats=s.teamFullStats,u.playerFullStats=s.playerFullStats,u.roundReportStats=s.roundReportStats,u.pointScheme=s.pointScheme,u.tournamentName=s.tournamentName,u.tab=r.get("nfStatsTab")||"team_standings",u.activePhase=s.activePhase,u.toast=function(e){var n=e.message,t=e.success,o=void 0===t?null:t,s=e.hideAfter,r=void 0!==s&&s;r&&a(function(){u.toastMessage=null},2500),u.toastMessage={message:n,success:o}},e.$watch(angular.bind(u,function(){return u.tab}),function(e){r.set("nfStatsTab",e)}),u.refreshStats=function(){var e={message:"Refreshing stats."};u.toast(e),s.refreshStats(i,u.phase?u.phase.id:null).then(function(){e.message="Loaded stats for "+(u.phase?u.phase.name+".":"all games."),e.success=!0}).catch(function(n){e.message="Could not reload stats.",e.success=!1}).finally(function(){e.hideAfter=!0,u.toast(e)})},u.setHashLocation=function(e){a(function(){t.location.hash="#"+e},50)},o.getPhases(i).then(function(){return u.refreshStats()})}function n(e){return e.location.pathname.split("/")[2]}angular.module("statsApp",["ngCookies","ngAnimate","tournamentApp"]).config(["$animateProvider",function(e){e.classNameFilter(/angular-animate/)}]),angular.module("statsApp").controller("PublicStatsController",["$scope","$window","$timeout","Phase","Stats","Cookies",e])}(),function(){function e(e,n,t){var a=this;a.searchQuery="",a.searchResults=[],a.timeoutRequest=null,a.collaborators=t.collaborators,a.getCollaborators=function(){return t.getCollaborators(e.tournamentId)},a.getKeyPress=function(e){a.searchQuery.trim().length>=2&&(a.timeoutRequest&&n.cancel(a.timeoutRequest),a.timeoutRequest=n(function(){a.findUsers(),a.timeoutRequest=null},333))},a.findUsers=function(){a.searchQuery.trim().length>0&&t.findUsers(a.searchQuery).then(function(e){var n=e.users;return a.searchResults=n}).catch(function(e){return console.log(e)})},a.addCollaborator=function(n){var s=!(arguments.length<=1||void 0===arguments[1])&&arguments[1],r={message:"Adding "+n};e.toast(r),t.postCollaborator(e.tournamentId,n,s).then(function(){o(n),a.getCollaborators(),r.message="Added "+n,r.success=!0}).catch(function(e){r.message="Could not add "+n,r.success=!1}).finally(function(){r.hideAfter=!0,e.toast(r)})},a.toggleAdmin=function(n){t.updateCollaborator(e.tournamentId,n.username,!n.admin).catch(function(n){e.toast({message:"Could not change permissions",success:!1,hideAfter:!0})})};var o=function(e){for(var n=0;a.searchResults[n]&&a.searchResults[n].username!==e;)n++;a.searchResults.splice(n,1)};a.removeCollaborator=function(n){return t.deleteCollaborator(e.tournamentId,n)},a.getCollaborators()}angular.module("tournamentApp").controller("CollabCtrl",["$scope","$timeout","Collaborator",e])}(),function(){function e(e,n,t,a,o,s){var r=this;r.editingPointScheme=!1,r.editingRules=!1,r.pointScheme=t.pointScheme,r.rules=t.rules,r.rulesCopy={},r.pointSchemeCopy={tossupValues:[]},r.newPointValue={type:null},r.newDivision={name:""},r.games=a.games,r.divisions=o.divisions,r.phases=s.phases,r.resetPointSchemeCopyToOriginal=function(){angular.copy(r.pointScheme,r.pointSchemeCopy),r.pointSchemeCopy.tossupValues.sort(function(e,n){return e.value-n.value})},r.resetRules=function(){angular.copy(r.rules,r.rulesCopy)},r.saveRules=function(){var n=angular.equals(r.rulesCopy,r.rules);!n&&r.editConfigurationRules.$valid?!function(){var n={message:"Updating rules."};t.updateRules(e.tournamentId,r.rulesCopy).then(function(){r.resetRules(),n.message="Updated rules",n.success=!0,r.editingRules=!1}).catch(function(){n.message="Could not update rules",n.success=!1}).finally(function(){n.hideAfter=!0,e.toast(n)})}():n&&r.editConfigurationRules.$valid&&(r.editingRules=!1)},r.editPointScheme=function(){!u()&&r.editPointSchemeForm.$valid&&!function(){var n={message:"Saving point values"};e.toast(n),t.postPointValues(e.tournamentId,r.pointSchemeCopy).then(function(){r.resetPointSchemeCopyToOriginal(),r.editingPointScheme=!1,n.message="Saved point values",n.success=!0}).catch(function(e){n.message="Could not save point values",n.success=!1}).finally(function(){n.hideAfter=!0,e.toast(n)})}()},r.addNewPointValue=function(){r.newPointValue.type&&r.newPointValue.value&&r.newPointValueForm.$valid&&!function(){var n={message:"Adding point value"};e.toast(n),t.addPointValue(e.tournamentId,r.newPointValue).then(function(e){r.resetPointSchemeCopyToOriginal(),n.message="Added point value",n.success=!0,r.newPointValue={}}).catch(function(e){n.message="Could not add point value",n.success=!1}).finally(function(){n.hideAfter=!0,e.toast(n)})}()},r.removeFromPointSchemeCopy=function(e){r.pointSchemeCopy.tossupValues=r.pointSchemeCopy.tossupValues.filter(function(n){return n!==e})},r.saveDivision=function(n){var t=n.newName.trim();n.name.trim()!==t&&0!==t.length?!function(){var t={message:"Saving division."},a=n.name;e.toast(t),o.editDivision(e.tournamentId,n).then(function(e){t.success=!0,t.message="Changed division: "+a+" → "+e}).catch(function(e){t.success=!1,t.message="Could not update division."}).finally(function(){t.hideAfter=!0,e.toast(t),n.editing=!1})}():n.editing=!1},r.addNewDivision=function(){var n=r.newDivision.name.trim();n.length>0&&r.newDivision.phaseId&&!function(){var t={message:"Adding division"};e.toast(t),o.addDivision(e.tournamentId,n,r.newDivision.phaseId).then(function(e){t.message="Added division: "+e,t.success=!0,r.newDivision={name:""}}).catch(function(e){t.message="Could not add division",t.success=!1}).finally(function(){t.hideAfter=!0,e.toast(t)})}()},r.removeDivision=function(n){var t={message:"Removing division."};e.toast(t),o.removeDivision(e.tournamentId,n).then(function(){t.message="Removed division.",t.success=!0}).catch(function(){t.message="Could not remove division",t.success=!1}).finally(function(){t.hideAfter=!0,e.toast(t)})};var u=function(){for(var e={},n=0;n<r.pointSchemeCopy.tossupValues.length;n++){if(e[r.pointSchemeCopy.tossupValues[n].value])return!0;e[r.pointSchemeCopy.tossupValues[n].value]=!0}return!1};n(function(){r.resetPointSchemeCopyToOriginal(),r.resetRules()},500),o.getDivisions(e.tournamentId)}angular.module("tournamentApp").controller("ConfigCtrl",["$scope","$timeout","Tournament","Game","Division","Phase",e])}(),function(){function e(e,n,t,a,o){function s(e){if(!e)return 0;var n=e.players.map(function(e){var n=0;for(var t in e.points)e.points.hasOwnProperty(t)&&t>0&&(n+=e.points[t]);return n}).reduce(function(e,n){return e+n},0);return n}function r(){c.resetCurrentGame(),c.newGameForm.$setUntouched()}function u(e,n){var t=e.phases.reduce(function(e,n){return e[n.id]=!0,e},{});return n.filter(function(e){return t[e.id]===!0})}function i(e,n){e.teams.forEach(function(e){var t=n.findIndex(function(n){return n.id===e.id});t!==-1&&(e.teamInfo=n[t])})}var c=this;c.teams=n.teams,c.games=t.games,c.phases=a.phases,c.sortType="round",c.sortReverse=!1,c.gameQuery="",c.pointScheme=o.pointScheme,c.rules=o.rules,c.pointSum=function(e){if(!e)return 0;var n=Object.keys(e);return n.reduce(function(n,t){var a=e[t+""]*t||0;return n+a},0)},c.teamBonusPoints=function(e){if(!e)return 0;var n=e.players.map(function(e){return c.pointSum(e.points)}).reduce(function(e,n){return e+n},0);return(e.score||0)-n-(e.bouncebacks||0)},c.teamPPB=function(e){if(!e)return 0;if(0===e.players.length)return 0;var n=s(e)-(e.overtime||0),t=c.teamBonusPoints(e);return t/n||0},c.currentGame={teams:[{teamInfo:null,players:[]},{teamInfo:null,players:[]}],phases:[],round:1,tuh:20,room:null,moderator:null,packet:null,notes:null},c.loadedGame={},c.loadedGameOriginal={},c.addTeam=function(n){var a={message:"Loading "+n.teamInfo.name+" players."};e.toast(a),t.getTeamPlayers(e.tournamentId,n.teamInfo.id).then(function(e){n.players=e.map(function(e){var n=e.name,t=e.id;return{id:t,name:n,points:c.pointScheme.tossupValues.reduce(function(e,n){return e[n.value]=0,e},{}),tuh:c.currentGame.tuh}}),a.success=!0,a.message="Loaded "+n.teamInfo.name+" players ("+n.players.length+")"}).catch(function(e){a.success=!1,a.message="Could not load team."}).finally(function(){a.hideAfter=!0,e.toast(a)})},c.getGames=function(){return t.getGames(e.tournamentId)},c.resetForm=r,c.addGame=function(){c.newGameForm.$valid&&!function(){var n={message:"Adding match."};e.toast(n),t.postGame(e.tournamentId,c.currentGame).then(function(){c.resetForm(),c.getGames(),n.success=!0,n.message="Added match"}).catch(function(e){n.success=!1,n.message="Could not add match"}).finally(function(){n.hideAfter=!0,e.toast(n)})}()},c.loadGame=function(n){var a={message:"Loading game."};e.toast(a),t.getGameById(e.tournamentId,n).then(function(e){e.phases=u(e,c.phases),i(e,c.teams),angular.copy(e,c.loadedGame),angular.copy(c.loadedGame,c.loadedGameOriginal),a.message="Loaded game",a.success=!0}).catch(function(e){a.message="Could not load game",a.success=!1}).finally(function(){a.hideAfter=!0,e.toast(a)})},c.resetLoadedGame=function(){return angular.copy(c.loadedGameOriginal,c.loadedGame)},c.editLoadedGame=function(){c.editGameForm.$valid&&!function(){var n={message:"Editing match."};e.toast(n),t.editGame(e.tournamentId,c.loadedGame.id,c.loadedGame).then(function(){c.loadedGame.editing=!1,c.getGames(),n.message="Edited match.",n.success=!0}).catch(function(e){n.message="Could not edit match",n.success=!1}).finally(function(){n.hideAfter=!0,e.toast(n)})}()},c.deleteGame=function(n){n&&!function(){var a={message:"Deleting match."};e.toast(a),t.deleteGame(e.tournamentId,n).then(function(){c.loadedGame={},a.message="Deleted match.",a.success=!0}).catch(function(e){a.message="Could not delete match.",a.success=!1}).finally(function(){a.hideAfter=!0,e.toast(a)})}()},c.resetCurrentGame=function(){c.currentGame={teams:[{teamInfo:null,players:[]},{teamInfo:null,players:[]}],phases:[],round:1,tuh:20,room:null,moderator:null,packet:null,notes:null}},c.numPlayerAnswers=function(e){var n=!(arguments.length<=1||void 0===arguments[1])&&arguments[1],t=0;for(var a in e.points)e.points.hasOwnProperty(a)&&(a>=0||!n)&&(t+=e.points[a]||0);return t},c.minPossibleTossupsHeard=function(e){var n=e.teams?e.teams.reduce(function(e,n){var t=n.players.reduce(function(e,n){return e+c.numPlayerAnswers(n,!0)},0);return e+t},0):0,t=e.teams?e.teams.reduce(function(e,n){var t=n.players.reduce(function(e,n){var t=0;for(var a in n.points)n.points.hasOwnProperty(a)&&a<0&&(t+=n.points[a]);return e+t},0);return e+=t},0):0;if(t>n){var a=t-n;return a+n}return n},c.matchSearch=function(e){var n=c.gameQuery.toLowerCase(),t=(e.round,e.teams),a=t.one.name.toLowerCase(),o=t.two.name.toLowerCase();return e.round==n||a.indexOf(n)!==-1||o.indexOf(n)!==-1},c.getGames()}angular.module("tournamentApp").filter("preventSameMatchTeams",function(){return function(e,n){return e.filter(function(e){return e.id!==n})}}),angular.module("tournamentApp").controller("GameCtrl",["$scope","Team","Game","Phase","Tournament",e])}(),function(){function e(e,n){var t=this;t.phases=n.phases,t.newPhase="",t.activePhase=n.activePhase,t.getPhases=function(){return n.getPhases(e.tournamentId)},t.addPhase=function(){var a=t.newPhase.trim();t.isValidNewPhaseName(a)&&!function(){var o={message:"Adding phase."};e.toast(o),n.postPhase(e.tournamentId,a).then(function(e){t.newPhase="",o.success=!0,o.message="Added phase: "+e}).catch(function(e){o.success=!1,o.message="Couldn't add phase"}).finally(function(){o.hideAfter=!0,e.toast(o)})}()},t.removePhase=function(t){var a={message:"Deleting phase: "+t.name};e.toast(a),n.deletePhase(e.tournamentId,t.id).then(function(e){a.success=!0,a.message="Deleted phase: "+e}).catch(function(e){a.success=!1,a.message="Couldn't delete phase: "+t.name}).finally(function(){a.hideAfter=!0,e.toast(a)})},t.updateActivePhase=function(a){t.activePhase.id!==a.id&&n.updateActivePhase(e.tournamentId,a.id).catch(function(n){e.toast({message:"Could not change active phase to: "+a.name,success:!1,hideAfter:!0})})},t.editPhase=function(a){t.phaseNameWasChanged(a)?!function(){var t={message:"Editing phase."},o=a.name;e.toast(t),n.editPhase(e.tournamentId,a.newName.trim(),a.id).then(function(e){t.message="Updated phase: "+o+" → "+e,t.success=!0,a.newName=e,a.name=e,a.editing=!1}).catch(function(){t.message="Couldn't update phase",t.success=!1}).finally(function(){t.hideAfter=!0,e.toast(t)})}():a.editing=!1},t.phaseNameWasChanged=function(e){var n=e.newName.trim(),t=e.name.trim();return n!==t&&n.length>0},t.isValidNewPhaseName=function(e){return e=e.toLowerCase(),e.length>0&&!t.phases.some(function(n){return n.name.toLowerCase()===e})},t.getPhases()}angular.module("tournamentApp").controller("PhaseCtrl",["$scope","Phase",e])}(),function(){function e(e,n,t,a,o,s,r){function u(){g.scoresheetTime.setSeconds(g.scoresheetTime.getSeconds()+1),g.diff=g.scoresheetTime.getSeconds()-g.originalTime.getSeconds()}function i(){return{teams:[{teamInfo:null,players:[],newPlayer:"",overtime:0},{teamInfo:null,players:[],newPlayer:"",overtime:0}],cycles:p(20),currentCycle:{number:1,answers:[],bonuses:[]},onTossup:!0,round:0,packet:null,notes:null,moderator:null,phases:[],room:null}}function c(e){for(var n=[],t=0;t<e;t++)n[t]=void 0;return n}function m(e,n){return n.answers.findIndex(function(n){return n.teamId===e.id})===-1}function l(e){return e.answers.some(function(e){return"Neg"!==e.type})}function d(e,n){return n.answers.some(function(n){return n.teamId===e&&"Neg"!==n.type})}function f(e){g.game.teams.forEach(function(n){n.players.forEach(function(n){n.active&&n.tuh+e>=0&&(n.tuh+=e)})})}function p(e){for(var n=[],t=0;t<e;t++)n.push({answers:[],bonuses:[]});return n}function h(){g.game.lastSavedAt=new Date,r.localStorage.set("scoresheet_"+e.tournamentId,JSON.stringify(g.game))}var g=this;g.teams=a.teams,g.pointScheme=t.pointScheme,g.rules=t.rules,g.phases=o.phases,g.game=i(),g.newScoresheet=i,g.scoresheetTime=new Date(1e3),g.originalTime=new Date(g.scoresheetTime),g.diff=0;var v=n(u,1e3);g.stopTimer=function(){return n.cancel(v)},g.startTimer=function(){return v=n(u,1e3)},g.loadTeamPlayers=function(n){var t=n.teamInfo,o=t.id,s=t.name,r={message:"Loading "+s+" players."};e.toast(r),a.getTeamById(e.tournamentId,o).then(function(e){var t=e.players;n.players=t,n.players.forEach(function(e,n){e.active=n<g.rules.maxActive,e.tuh=0}),r.message="Loaded "+s+" players.",r.success=!0}).catch(function(e){r.message="Could not load "+s+" players.",r.success=!1}).finally(function(){r.hideAfter=!0,e.toast(r)})},g.addPlayer=function(n){n.newPlayer.length>0&&!function(){var t={message:"Adding "+n.newPlayer+" to "+n.teamInfo.name};e.toast(t),a.addPlayer(e.tournamentId,n.teamInfo.id,n.newPlayer).then(function(e){n.players.push({name:e.name,id:e.id,tuh:0,active:n.players.length+1<=g.rules.maxActive}),n.newPlayer="",t.message="Added "+e.name+" to "+n.teamInfo.name,t.success=!0}).catch(function(e){t.message="Could not add "+n.newPlayer+" to "+n.teamInfo.name,t.success=!1}).finally(function(){t.hideAfter=!0,e.toast(t)})}()},g.getNumberOfActivePlayers=function(e){return e.filter(function(e){return e.active}).length},g.getTeamBouncebacks=function(e){var n=0;if(g.game.cycles.forEach(function(t){if(!d(e,t)&&l(t)){var a=t.bonuses.filter(function(n){return n===e}).length;n+=a*g.pointScheme.bonusPointValue}}),!d(e,g.game.currentCycle)&&l(g.game.currentCycle)){var t=g.game.currentCycle.bonuses.filter(function(n){return n===e}).length;n+=t*g.pointScheme.bonusPointValue}return n},g.range=function(e){return new Array(e)},g.swapPlayers=function(e,n,t){t<0?t=e.length-1:t===e.length&&(t=0);var a=[];angular.copy(e,a);var o=e[n];a[n]=a[t],a[t]=o,angular.copy(a,e)},g.getNumberOfAnswersForPlayer=function(e){return g.game.cycles.reduce(function(n,t){var a=t.answers.some(function(n){return n.playerId===e.id});return n+(a?1:0)},0)},g.setTeamThatGotBonusPartCurrentCycle=function(e,n,t){t[e]=t[e]===n.id?null:n.id},g.getTeamThatGotTossup=function(e){var n=e.answers.findIndex(function(e){return"Neg"!==e.type});return n===-1?null:e.answers[n].teamId},g.getTeamBonusPointsForCycle=function(e,n){var t=n+1===g.game.currentCycle.number?g.game.currentCycle:g.game.cycles[n];return t.bonuses.filter(function(n){return n===e}).length*g.pointScheme.bonusPointValue},g.getTeamScoreUpToCycle=function(e,n){for(var t=0,a=0;a<=n;a++){var o=g.game.cycles[a];o.answers.forEach(function(n){n.teamId===e&&(t+=n.value)}),t+=o.bonuses.filter(function(n){return n===e}).length*g.pointScheme.bonusPointValue}return n+1===g.game.currentCycle.number&&(g.game.currentCycle.answers.forEach(function(n){n.teamId===e&&(t+=n.value)}),t+=g.game.currentCycle.bonuses.filter(function(n){return n===e}).length*g.pointScheme.bonusPointValue),t},g.nextCycle=function(){var e=g.game.currentCycle.number+1,n=g.game.currentCycle.number-1;n>=g.game.cycles.length-1&&g.game.cycles.push({answers:[],bonuses:[]}),angular.copy(g.game.currentCycle.answers,g.game.cycles[n].answers),angular.copy(g.game.currentCycle.bonuses,g.game.cycles[n].bonuses),g.game.currentCycle={number:e,answers:[],bonuses:[]},f(1),h()},g.lastCycle=function(){if(g.game.currentCycle.number>1){var e=g.game.currentCycle.number-1;g.game.cycles[e]={answers:[],bonuses:[]},g.game.cycles[e-1].bonuses=[],g.game.cycles[e-1].answers=[],g.game.currentCycle={answers:[],bonuses:[],number:g.game.currentCycle.number-1}}f(-1),h()},g.getPlayerAnswerForCycle=function(e,n){return n.answers.find(function(n){return n.playerId===e.id})},g.addPlayerAnswerToCurrentCycle=function(e,n,t){m(n,g.game.currentCycle)&&g.game.currentCycle.answers.push({playerId:e.id,teamId:n.id,value:t.value,type:t.type})},g.getNumberOfTossupTypeForPlayer=function(e,n){var t=g.game.cycles.reduce(function(t,a){var o=a.answers.filter(function(t){return t.playerId===e.id&&t.value===n.value}).length;return t+o},0),a=g.game.currentCycle.answers.filter(function(t){return t.playerId===e.id&&t.type===n.type}).length;return t+a},g.getPlayerTotalPoints=function(e){var n=0;return g.pointScheme.tossupValues.forEach(function(t){var a=g.getNumberOfTossupTypeForPlayer(e,t);n+=a*t.value}),n},g.switchToBonusIfTossupGotten=function(e,n){"Neg"!==e.type&&g.teamDidNotNegInCycle(n,g.game.currentCycle)&&g.switchCurrentCycleContext(!0)},g.removeLastAnswerFromCycle=function(e){e.answers.pop(),e.bonuses=[]},g.getTeam=function(e){if(e)return g.game.teams.find(function(n){return n.teamInfo.id===e})},g.switchCurrentCycleContext=function(e){g.game.onTossup=!e},g.teamDidNotNegInCycle=function(e,n){return n.answers.findIndex(function(n){return"Neg"===n.type&&n.teamId===e})===-1},g.removeTeamNegsFromCycle=function(e,n){n.answers=n.answers.filter(function(n){return!("Neg"===n.type&&n.teamId===e)})},g.loadLastSavedScoresheet=function(){var n=r.localStorage.get("scoresheet_"+e.tournamentId);if(n)try{g.game=JSON.parse(n),e.toast({message:"Loaded scoresheet.",success:!0,hideAfter:!0})}catch(n){e.toast({message:"Could not read scoresheet.",success:!1,hideAfter:!0})}else e.toast({message:"No prior saved scoresheet",success:!1,hideAfter:!0})},g.displayPlayerAnswerForCycle=function(e,n){var t=g.game.cycles[n];n<g.game.currentCycle.number-1&&!function(){t.editing||(t.editing={}),t.newAnswer||(t.newAnswer={});var n=g.getPlayerAnswerForCycle(e,t);n?t.newAnswer[e.id]=g.pointScheme.tossupValues.find(function(e){return e.value===n.value}):t.newAnswer[e.id]=null,t.editing[e.id]=!0}()},g.displayCycleBonuses=function(e,n){var t=g.game.cycles[n];n<g.game.currentCycle.number-1&&l(t)&&(t.bonusesCopy=[],angular.copy(t.bonuses,t.bonusesCopy),t.editingBonus=!0)},g.editPlayerAnswerForCycle=function(e,n,t,a){var o=void 0;o=t&&"Neg"!==t.type?function(e){return e.teamId!==n&&"Neg"===e.type}:function(e){return e.teamId!==n&&"Neg"!==e.type};var s=a.answers.filter(o);t&&s.push({playerId:e,teamId:n,value:t.value,type:t.type}),a.answers=s,l(a)||(a.bonuses=[]),a.editing||(a.editing={}),a.editing[e]=!1},g.editCycleBonuses=function(e){e.bonusesCopy&&(angular.copy(e.bonusesCopy,e.bonuses),e.editingBonus=!1)},g.submitScoresheet=function(){g.scoresheetForm.$valid?g.game.submitted?e.toast({message:"This match has already been submitted.",success:!1,hideAfter:!0}):!function(){var n=g.parseScoresheet(g.game),t={message:"Adding match."};e.toast(t),s.postGame(e.tournamentId,n).then(function(n){g.game.id=n[0].id,g.game.submitted=!0,h(),t.success=!0,t.message="Added match",s.getGames(e.tournamentId)}).catch(function(e){t.success=!1,t.message="Failed to add match."}).finally(function(){t.hideAfter=!0,e.toast(t)})}():e.toast({message:"Please fix the errors on the scoresheet.",success:!1,hideAfter:!0})},g.parseScoresheet=function(e){var n={moderator:e.moderator,notes:e.notes,packet:e.packet,phases:e.phases,room:e.room,round:e.round,tuh:e.currentCycle.number-1,teams:e.teams.map(function(n){return{teamInfo:n.teamInfo,players:n.players.filter(function(e){return e.tuh>0}).map(function(e){return{id:e.id,tuh:e.tuh,points:g.pointScheme.tossupValues.reduce(function(n,t){return n[t.value]=g.getNumberOfTossupTypeForPlayer(e,t),n},{})}}),score:g.getTeamScoreUpToCycle(n.teamInfo.id,e.currentCycle.number-1),bouncebacks:g.getTeamBouncebacks(n.teamInfo.id),overtime:n.overtime||0}}),scoresheet:e.cycles.filter(function(n,t){return t<e.currentCycle.number-1}).map(function(e,n){return{number:n+1,answers:e.answers,bonuses:c(g.pointScheme.partsPerBonus).map(function(n,t){return{part:t+1,teamThatGotBonus:e.bonuses[t]||null}})}})};return n},g.revertScoresheetSubmission=function(){var n=g.game.id;n&&!function(){var t={message:"Reverting submission."};e.toast(t),s.deleteGame(e.tournamentId,n).then(function(){g.game.id=null,g.game.submitted=!1,t.message="Reverted submission",t.success=!0}).catch(function(e){t.message="Could not revert submission",t.success=!1}).finally(function(){t.hideAfter=!0,e.toast(t)})}()}}angular.module("tournamentApp").controller("ScoresheetCtrl",["$scope","$interval","Tournament","Team","Phase","Game","Cookies",e])}(),function(){function e(e,n){var t=this;t.downloadQBJ=function(){var t={message:"Generating QBJ file."};e.toast(t),n.getQBJReport(e.tournamentId,{download:!0,fileName:e.tournamentInfo.name.toLowerCase().replace(/ /g,"_")}).then(function(){t.message="Generated QBJ file.",t.success=!0}).catch(function(e){t.message="Could not download QBJ file.",t.success=!1}).finally(function(){t.hideAfter=!0,e.toast(t)})}}angular.module("tournamentApp").controller("StatisticsCtrl",["$scope","Stats",e])}(),function(){function e(e,n,t,a,o,s){function r(){m.newTeam={name:"",players:[{name:""},{name:""},{name:""},{name:""}],divisions:{}}}function u(e){m.currentTeam.newName=e,m.currentTeam.name=e,m.currentTeam.editingName=!1}function i(e,n){e.name=n,e.newName=n,e.editing=!1}function c(e){var n=m.currentTeam.players.findIndex(function(n){return n.id===e});n!==-1&&m.currentTeam.players.splice(n,1)}var m=this;m.teams=t.teams,m.phases=a.phases,m.divisions=o.divisions;var l=s.games;m.newTeam={name:"",players:[{name:""},{name:""},{name:""},{name:""}],divisions:{}},m.currentTeam={},m.teamSortType="name",m.teamSortReverse=!1,m.teamQuery="",m.getTournamentTeams=function(){t.getTeams(e.tournamentId)},m.addPlayer=function(){return m.newTeam.players.push({name:""})},m.removePlayerSlot=function(e){return m.newTeam.players.splice(e,1)},m.addTeam=function(){m.newTeamForm.$valid&&!function(){var n={message:"Adding team."};e.toast(n),t.postTeam(e.tournamentId,m.newTeam).then(function(e){r(),n.message="Added team: "+e,n.success=!0}).catch(function(e){n.message="Could not add team.",n.success=!1}).finally(function(){n.hideAfter=!0,e.toast(n)})}()},m.findTeam=function(n){n.id!==m.currentTeam.id&&!function(){var a={message:"Loading Team: "+n.name};e.toast(a),t.getTeamById(e.tournamentId,n.id).then(function(e){angular.copy(e,m.currentTeam),a.success=!0,a.message="Loaded team: "+e.name}).catch(function(e){a.success=!1,a.message="Could not load team: "+n.name}).finally(function(){a.hideAfter=!0,e.toast(a)})}()},m.saveCurrentTeamName=function(){var n=m.currentTeam,a=n.id,o=n.name,s=n.newName;o!==s&&s.length>0?m.isUniqueTeamName(a,s)&&!function(){var n={message:"Editing team: "+o+" → "+s};e.toast(n),t.editTeamName(e.tournamentId,a,s).then(function(e){u(e),n.success=!0,n.message="Saved team name: "+o+" → "+e}).catch(function(e){n.success=!1,n.message="Could not update team name: "+o+" → "+s}).finally(function(){n.hideAfter=!0,e.toast(n)})}():m.currentTeam.editingName=!1},m.updateCurrentTeamDivisions=function(){var n=m.currentTeam.name,a={message:"Updating divisions for: "+m.currentTeam.name};e.toast(a);var o=Object.keys(m.currentTeam.mappedDivisions).map(function(e){return m.currentTeam.mappedDivisions[e]});t.updateTeamDivisions(e.tournamentId,m.currentTeam.id,m.currentTeam.mappedDivisions,o).then(function(){a.success=!0,a.message="Updated divisions for: "+n}).catch(function(){a.success=!1,a.message="Could not update divisions for: "+n}).finally(function(){a.hideAfter=!0,e.toast(a)})},m.savePlayerNameOnCurrentTeam=function(n){var a=n.name,o=n.newName,s=n.id;a!==o&&o.length>0?m.isUniqueTeamPlayerName(s,o)&&!function(){var r={message:"Editing player: "+a+" → "+o};e.toast(r),t.editTeamPlayerName(e.tournamentId,s,o).then(function(e){i(n,e),r.success=!0,r.message="Saved player name: "+a+" → "+e}).catch(function(e){r.success=!1,r.message="Could not update player name: "+a+" → "+savedName}).finally(function(){r.hideAfter=!0,e.toast(r)})}():n.editing=!1},m.addTeamPlayer=function(){var n=m.currentTeam,a=n.newPlayer,o=n.id,s=n.name;a.length>0&&m.isUniqueTeamPlayerName(null,a)&&!function(){var n={message:"Adding player: "+a+" to "+s+"."};e.toast(n),t.addPlayer(e.tournamentId,o,a).then(function(e){m.currentTeam.players.push({id:e.id,name:e.name,newName:e.name,editing:!1,addedBy:e.added_by,games:0}),m.currentTeam.newPlayer="",n.success=!0,n.message="Added player: "+e.name+" to "+s}).catch(function(e){n.success=!1,n.message="Could not add player: "+player.name+" to "+s}).finally(function(){n.hideAfter=!0,e.toast(n)})}()},m.removeCurrentTeamPlayer=function(n){var a={message:"Deleting player: "+n.name};e.toast(a),t.deletePlayer(e.tournamentId,n.id).then(function(e){c(e),a.success=!0,a.message="Deleted player: "+n.name}).catch(function(e){a.success=!1,a.message="Could not delete "+n.name+" because this player has games played"}).finally(function(){a.hideAfter=!0,e.toast(a)})},m.removeCurrentTeam=function(){var n=m.currentTeam,a=n.id,o=n.name,s={message:"Deleting team: "+o};e.toast(s),t.deleteTeam(e.tournamentId,a).then(function(){s.success=!0,s.message="Deleted team: "+o,m.currentTeam={}}).catch(function(e){s.success=!1,s.message="Could not delete "+o+" because this team has games played."}).finally(function(){s.hideAfter=!0,e.toast(s)})},m.getDivisionNameInPhase=function(e){if(!e)return"";var n=m.divisions.find(function(n){return n.id===e});return n?n.name:""},m.teamHasPlayedNoGames=function(e){return!l.some(function(n){return n.teams.one.id===e||n.teams.two.id===e})},m.isUniqueTeamName=function(e,n){var t=n.trim().toLowerCase();return!m.teams.some(function(n){return n.id!==e&&n.name.trim().toLowerCase()===t})},m.isUniqueTeamPlayerName=function(e,n){var t=n.trim().toLowerCase();return!m.currentTeam.players.some(function(n){return n.id!==e&&n.name.trim().toLowerCase()===t})},m.getTournamentTeams()}angular.module("tournamentApp").controller("TeamCtrl",["$scope","$http","Team","Phase","Division","Game",e])}(),function(){function e(e,n,t,a,o,s,r,u,i){e.tournamentId=t.location.pathname.split("/")[2],e.tournamentContext={admin:!1,owner:!1},e.tournamentInfo={name:"",hidden:!1},e.toastMessage=null;var c=3e3,m=null;e.toast=function(n){var t=n.message,o=n.success,s=void 0===o?null:o,r=n.hideAfter,u=void 0!==r&&r;u&&(m&&a.cancel(m),m=a(function(){e.toastMessage=null,m=null},c)),e.toastMessage={message:t,success:s}};var l=this;l.tab=i.get("nfTab")||"overview",l.matchTab=i.get("nfMatchTab")||"add",l.teamTab=i.get("nfTeamTab")||"add",l.tournamentInfoCopy={},l.teams=s.teams,l.games=r.games,l.editing=!1,l.resetOverview=function(){angular.copy(e.tournamentInfo,l.tournamentInfoCopy)},l.editTournament=function(){l.editTournamentForm.$valid&&!function(){var n={message:"Editing tournament"};e.toast(n),u.edit(e.tournamentId,l.tournamentInfoCopy).then(function(e){d(e),l.resetOverview(),l.editing=!1,n.message="Edited tournament.",n.success=!0}).catch(function(e){n.message="Failed to update tournament.",n.success=!1}).finally(function(){n.hideAfter=!0,e.toast(n)})}()};var d=function(n){angular.copy(n,e.tournamentInfo)},f=function(){u.getTournamentContext(e.tournamentId).then(function(n){var t=n.tournamentInfo,a=n.tournamentContext;e.tournamentInfo=t,e.tournamentContext=a,angular.copy(e.tournamentInfo,l.tournamentInfoCopy)}).catch(function(e){console.log(e)})},p=function(){e.$watch(angular.bind(l,function(){return l.tab}),function(e){i.set("nfTab",e);
}),e.$watch(angular.bind(l,function(){return l.matchTab}),function(e){i.set("nfMatchTab",e)}),e.$watch(angular.bind(l,function(){return l.teamTab}),function(e){i.set("nfTeamTab",e)})};e.logout=function(){o.remove("nfToken",{path:"/"}),t.location="/"},p(),f()}angular.module("tournamentApp").controller("TournamentCtrl",["$scope","$http","$window","$timeout","$cookies","Team","Game","Tournament","Cookies",e])}(),function(){angular.module("tournamentApp").factory("Collaborator",["$http","$q","Cookies",function(e,n,t){function a(a,o,s){return n(function(n,r){var u=t.get("nfToken"),i={username:o,token:u,admin:s};e.post("/api/t/"+a+"/collaborators",i).then(function(e){var t=e.data,a={name:t.result.name,username:t.result.username,admin:t.result.is_admin};c.collaboratorFactory.collaborators.push(a),n()}).catch(function(e){r(e)})})}function o(n){var a=t.get("nfToken");e.get("/api/t/"+n+"/collaborators?token="+a).then(function(e){var n=e.data,t=n.result.map(function(e){var n=e.name,t=e.username,a=e.is_admin;return{name:n,username:t,admin:a}});angular.copy(t,c.collaboratorFactory.collaborators)}).catch(function(e){return console.log(e)})}function s(a,o,s){return n(function(n,r){var u=t.get("nfToken"),i={admin:s,token:u};e.put("/api/t/"+a+"/collaborators/"+o,i).then(function(e){var t=e.data;c.collaboratorFactory.collaborators.find(function(e){return e.username===t.result.username}).admin=t.result.is_admin,n()}).catch(function(e){r(e)})})}function r(a){return n(function(n,o){var s=t.get("nfToken");e({url:"/api/users?token="+s+"&search="+a,method:"GET"}).then(function(e){var t=e.data,a=t.users.filter(function(e){return e.username!==t.currentUser});n({users:a})}).catch(function(e){return o(e)})})}function u(a,o){return n(function(n,s){var r=t.get("nfToken");e.delete("/api/t/"+a+"/collaborators/"+o+"?token="+r).then(function(e){var t=e.data;i(t.result.username),n()}).catch(function(e){return s(e)})})}function i(e){var n=c.collaboratorFactory.collaborators.findIndex(function(n){return n.username===e});c.collaboratorFactory.collaborators.splice(n,1)}var c=this,m=[];return c.collaboratorFactory={collaborators:m,getCollaborators:o,deleteCollaborator:u,postCollaborator:a,updateCollaborator:s,findUsers:r},c.collaboratorFactory}])}(),function(){angular.module("tournamentApp").factory("Cookies",["$cookies",function(e){function n(n){return e.get(n)}function t(n){return e.getObject(n)}function a(n,t){e.put(n,t)}function o(n){console.log(e.get(n)),e.remove(n),console.log(e.get(n))}function s(n,t){e.putObject(n,t)}function r(){return{set:function(e,n){localStorage.setItem(e,n)},get:function(e){return localStorage.getItem(e)}}}var u=this;return u.cookieFactory={get:n,set:a,remove:o,getObject:t,setObject:s,localStorage:r()},u.cookieFactory}])}(),function(){angular.module("tournamentApp").factory("Division",["$q","$http","Cookies",function(e,n,t){function a(a){return e(function(e,o){var s=t.get("nfToken");n.get("/api/t/"+a+"/divisions?token="+s).then(function(n){var t=n.data,a=t.result.map(function(e){return{name:e.division_name,newName:e.division_name,id:e.division_id,phaseId:e.phase_id}});angular.copy(a,m.factory.divisions),e()}).catch(function(e){o(e)})})}function o(a,o){return e(function(e,s){var r={token:t.get("nfToken"),newName:o.newName};n.put("/api/t/"+a+"/divisions/"+o.id,r).then(function(n){var t=n.data;u(t.result),e(t.result.name)}).catch(function(e){s(e)})})}function s(a,o,s){return e(function(e,r){var u={token:t.get("nfToken"),name:o,phaseId:s};n.post("/api/t/"+a+"/divisions",u).then(function(n){var t=n.data;i(t.result),e(t.result.name)}).catch(function(e){return r(e)})})}function r(a,o){var s=o.id;return e(function(e,o){var r=t.get("nfToken");n.delete("/api/t/"+a+"/divisions/"+s+"?token="+r).then(function(n){var t=n.data;c(t.result.id),e()}).catch(function(e){o(e)})})}function u(e){var n=m.factory.divisions.findIndex(function(n){return n.id===e.id});m.factory.divisions[n].name=e.name,m.factory.divisions[n].newName=e.name}function i(e){var n=e.name,t=e.id,a=e.phase_id;m.factory.divisions.push({name:n,newName:n,id:t,phaseId:a})}function c(e){var n=m.factory.divisions.findIndex(function(n){return n.id===e});n!==-1&&m.factory.divisions.splice(n,1)}var m=this,l=[];return m.factory={getDivisions:a,editDivision:o,addDivision:s,removeDivision:r,divisions:l},m.factory}])}(),function(){angular.module("tournamentApp").factory("Game",["$http","$q","Cookies",function(e,n,t){function a(a,o){var s=c(o);return n(function(n,o){var r={token:t.get("nfToken"),game:s};e.post("/api/t/"+a+"/matches",r).then(function(e){var t=e.data;n(t.result)}).catch(function(e){return o(e)})})}function o(n){var a=t.get("nfToken");e.get("/api/t/"+n+"/matches?token="+a).then(function(e){var n=e.data,t=n.matches.map(function(e){var n=e.match_id,t=e.tossups_heard,a=e.round,o=e.team_1_id,s=e.team_1_score,r=e.team_2_id,u=e.team_2_score,i=e.team_1_name,c=e.team_2_name,m=e.phases;return{id:n,tuh:t,round:a,teams:{one:{score:s,id:o,name:i},two:{score:u,id:r,name:c}},phases:m.reduce(function(e,n){return e[n.phase_id]=!0,e},{})}});angular.copy(t,l.gameFactory.games)})}function s(a,o){return n(function(n,s){var r=t.get("nfToken");e.get("/api/t/"+a+"/teams/"+o+"?token="+r).then(function(e){var t=e.data,a=t.result.players.map(function(e){var n=e.player_name,t=e.player_id;return{id:t,name:n}});n(a)}).catch(function(e){s(e)})})}function r(a,o){return n(function(n,s){var r=t.get("nfToken");e.get("/api/t/"+a+"/matches/"+o+"?token="+r).then(function(e){var t=e.data,a=t.result,o={addedBy:a.added_by,id:a.match_id,tuh:a.tossups_heard,moderator:a.moderator,notes:a.notes,packet:a.packet,room:a.room,round:a.round,teams:a.teams.map(function(e){return{id:e.team_id,name:e.team_name,overtime:e.overtime_tossups,bouncebacks:e.bounceback_points,score:e.score,players:e.players.map(function(e){return{id:e.player_id,name:e.player_name,tuh:e.tossups_heard,points:e.tossup_values.reduce(function(e,n){return e[n.value]=n.number,e},{})}})}}),phases:a.phases.map(function(e){return{id:e.phase_id,name:e.phase_name}})};n(o)}).catch(function(e){return s(e)})})}function u(a,o,s){return n(function(n,r){var u={token:t.get("nfToken"),game:c(s)};e.put("/api/t/"+a+"/matches/"+o,u).then(function(e){var t=e.data,a=t.result;n(a)}).catch(function(e){return r(e)})})}function i(a,o){return n(function(n,s){var r=t.get("nfToken");e.delete("/api/t/"+a+"/matches/"+o+"?token="+r).then(function(e){var t=e.data,a=t.result.id;m(a),n()}).catch(function(e){return s(e)})})}function c(e){var n={};return angular.copy(e,n),n.phases=n.phases.map(function(e){return e.id}),n.teams=n.teams.map(function(e){return{id:e.teamInfo.id,score:e.score,bouncebacks:e.bouncebacks,overtime:e.overtime,players:e.players.map(function(e){return{id:e.id,tuh:e.tuh||0,points:Object.keys(e.points).map(Number).map(function(n){return{value:n,number:e.points[n]||0}})}})}}),n}function m(e){var n=l.gameFactory.games.findIndex(function(n){return n.id===e});n!==-1&&l.gameFactory.games.splice(n,1)}var l=this,d=[];return l.gameFactory={games:d,postGame:a,getGames:o,deleteGame:i,getTeamPlayers:s,getGameById:r,editGame:u},l.gameFactory}])}(),function(){angular.module("tournamentApp").factory("Phase",["$http","$q","Cookies","Tournament",function(e,n,t,a){function o(a,o){return n(function(n,s){var r={token:t.get("nfToken"),name:o};e.post("/api/t/"+a+"/phases",r).then(function(e){var t=e.data;l(t.result),1===f.phaseFactory.phases.length?i(a,t.result.id).then(function(){return n(t.result.name)}):n(t.result.name)}).catch(function(e){return s(e)})})}function s(a,o,s){return n(function(n,r){var u={token:t.get("nfToken"),newName:o};e.put("/api/t/"+a+"/phases/"+s,u).then(function(e){var t=e.data;m(t.result.id,t.result.name),n(t.result.name)}).catch(function(e){return r(e)})})}function r(a){return n(function(n,o){var s=t.get("nfToken");e.get("/api/t/"+a+"/phases?token="+s).then(function(e){var t=e.data,a=t.result.map(function(e){var n=e.name,t=e.id;return{name:n,newName:n,id:t}});angular.copy(a,f.phaseFactory.phases),n(a)}).catch(function(e){return o(e)})})}function u(a,o){return n(function(n,s){var r=t.get("nfToken");e.delete("/api/t/"+a+"/phases/"+o+"?token="+r).then(function(e){var t=e.data;d(t.result.id,a),f.phaseFactory.phases.length>0&&t.result.id===f.phaseFactory.activePhase.id?i(a,f.phaseFactory.phases[0].id).then(function(){return n(t.result.name)}):(c(null),n(t.result.name))}).catch(function(e){return s(e)})})}function i(a,o){return n(function(n,s){var r={token:t.get("nfToken")};e.put("/api/t/"+a+"/phases/"+o+"/active",r).then(function(e){var t=e.data;c(t.result.active_phase_id),n()}).catch(function(e){return s(e)})})}function c(e){var n=f.phaseFactory.phases.find(function(n){return n.id===e});f.phaseFactory.activePhase.id=n?n.id:null,f.phaseFactory.activePhase.name=n?n.name:null}function m(e,n){var t=f.phaseFactory.phases.findIndex(function(n){return n.id===e});t!==-1&&(f.phaseFactory.phases[t].name=n,f.phaseFactory.activePhase.id===e&&c(e))}function l(e){var n=e.name,t=e.id;f.phaseFactory.phases.push({name:n,id:t,newName:n})}function d(e,n){var t=f.phaseFactory.phases.findIndex(function(n){return n.id===e});t!==-1&&f.phaseFactory.phases.splice(t,1)}var f=this,p=[],h=a.activePhase;return f.phaseFactory={phases:p,postPhase:o,editPhase:s,getPhases:r,deletePhase:u,updateActivePhase:i,activePhase:h},f.phaseFactory}])}(),function(){angular.module("tournamentApp").factory("Team",["$http","$q","Cookies","Phase","Division",function(e,n,t,a,o){function s(a,o){return n(function(n,s){var u=p(o),i={team:u,token:t.get("nfToken")};e.post("/api/t/"+a+"/teams",i).then(function(e){var t=e.data;r(a),n(t.team.team.name)}).catch(function(e){return s(e)})})}function r(n){var a=t.get("nfToken");e.get("/api/t/"+n+"/teams?token="+a).then(function(e){var n=e.data,t=n.teams.map(function(e){var n=e.team_id,t=e.name,a=e.team_divisions,o=void 0===a?[]:a;return{id:n,name:t,divisions:null===o?{}:o.reduce(function(e,n){return e[n.phase_id]=n.division_id,e},{})}});angular.copy(t,y.teamFactory.teams)}).catch(function(e){return reject(e)})}function u(a,o){return n(function(n,s){var r=t.get("nfToken");e.get("/api/t/"+a+"/teams/"+o+"?token="+r).then(function(e){var t=e.data,a=t.result,o=a.name,s=a.id,r=a.players,u=a.team_divisions,i=a.added_by,c=a.games_count,m={name:o,newName:o,id:s,players:r.map(function(e){var n=e.player_name,t=e.player_id,a=e.added_by,o=e.games;return{name:n,newName:n,id:t,addedBy:a,games:o}}),mappedDivisions:u.reduce(function(e,n){return e[n.phase_id]=n.division_id,e},{}),addedBy:i,games:c};n(m)}).catch(function(e){return s(e)})})}function i(a,o,s){return n(function(n,r){var u={token:t.get("nfToken"),name:s};e.put("/api/t/"+a+"/teams/"+o,u).then(function(e){var t=e.data,a=t.result,o=a.id,s=a.name;h(o,s),n(s)}).catch(function(e){return r(e)})})}function c(a,o,s,r){return n(function(n,u){var i={token:t.get("nfToken"),divisions:r};e.put("/api/t/"+a+"/teams/"+o+"/divisions",i).then(function(e){e.data;g(o,s),n()}).catch(function(e){return u(e)})})}function m(a,o,s){return n(function(n,r){var u={token:t.get("nfToken"),name:s};e.put("/api/t/"+a+"/players/"+o,u).then(function(e){var t=e.data;n(t.result.name)}).catch(function(e){return r(e)})})}function l(a,o,s){return n(function(n,r){var u={token:t.get("nfToken"),name:s,team:o};e.post("/api/t/"+a+"/players",u).then(function(e){var t=e.data;return n(t.result)}).catch(function(e){return r(e)})})}function d(a,o){return n(function(n,s){var r=t.get("nfToken");e.delete("/api/t/"+a+"/players/"+o+"?token="+r).then(function(e){var t=e.data;return n(t.result.id)}).catch(function(e){return s(e)})})}function f(a,o){return n(function(n,s){var r=t.get("nfToken");e.delete("/api/t/"+a+"/teams/"+o+"?token="+r).then(function(e){var t=e.data;v(t.result.id),n()}).catch(function(e){return s(e)})})}function p(e){var n={};return n.players=e.players.filter(function(e){return e.name.trim().length>0}),n.name=e.name.trim(),n.divisions=Object.keys(e.divisions).map(function(n){return e.divisions[n].id}),n}function h(e,n){var t=y.teamFactory.teams.findIndex(function(n){return n.id===e});t!==-1&&(y.teamFactory.teams[t].name=n)}function g(e,n){var t=y.teamFactory.teams.findIndex(function(n){return n.id===e});t!==-1&&(y.teamFactory.teams[t].divisions=n)}function v(e){var n=y.teamFactory.teams.findIndex(function(n){return n.id===e});y.teamFactory.teams.splice(n,1)}var y=this,T=[];a.phases,o.divisions;return y.teamFactory={teams:T,postTeam:s,getTeams:r,getTeamById:u,deleteTeam:f,editTeamName:i,editTeamPlayerName:m,updateTeamDivisions:c,addPlayer:l,deletePlayer:d},y.teamFactory}])}(),function(){angular.module("tournamentApp").factory("Tournament",["$http","$q","Cookies",function(e,n,t){function a(a){return n(function(n,o){var s=t.get("nfToken");e.get("/api/t/"+a+"?token="+s).then(function(e){var t=e.data,a=t.data.tournament,o=t.data.permissions,s={tossupValues:a.tossup_point_scheme,partsPerBonus:a.parts_per_bonus,bonusPointValue:a.bonus_point_value},r={bouncebacks:a.bouncebacks,maxActive:a.max_active_players_per_team},u={id:a.active_phase_id,name:a.active_phase_name};angular.copy(u,i.tournamentFactory.activePhase),angular.copy(r,i.tournamentFactory.rules),angular.copy(s,i.tournamentFactory.pointScheme),n({tournamentInfo:{name:a.name,location:a.location,date:new Date(a.tournament_date),questionSet:a.question_set,comments:a.comments,hidden:a.hidden},tournamentContext:{admin:o.is_owner||o.is_admin,owner:o.is_owner||!1}})}).catch(function(e){o(e)})})}function o(a,o){return n(function(n,s){var r=t.get("nfToken"),u={token:r,location:o.location,name:o.name,date:o.date,questionSet:o.questionSet,comments:o.comments,hidden:o.hidden};e.put("/api/t/"+a,u).then(function(e){var t=e.data,a=t.result,o=a.name,s=a.location,r=a.hidden,u=a.comments,i=a.question_set,c=a.tournament_date,m={name:o,location:s,hidden:r,comments:u,questionSet:i,date:new Date(c)};n(m)}).catch(function(e){return s(e)})})}function s(a,o){var s=o.bouncebacks,r=o.maxActive;return n(function(n,o){var u=t.get("nfToken"),c={token:u,rules:{bouncebacks:s,maxActive:r}};e.put("/api/t/"+a+"/rules",c).then(function(e){var t=e.data,a={bouncebacks:t.result.bouncebacks,maxActive:t.result.max_active_players_per_team};angular.copy(a,i.tournamentFactory.rules),n(i.tournamentFactory.rules)}).catch(function(e){return o(e)})})}function r(a,o){var s=o.type,r=o.value;return n(function(n,o){var u=(t.get("nfToken"),{type:s,value:r});e.post("/api/t/"+a+"/pointscheme",u).then(function(e){var t=e.data;i.tournamentFactory.pointScheme.tossupValues.push({type:t.result.tossup_answer_type,value:t.result.tossup_value}),n({type:s,value:r})}).catch(function(e){return o(e)})})}function u(a,o){return n(function(n,s){var r=t.get("nfToken"),u={token:r,pointValues:o};e.put("/api/t/"+a+"/pointscheme",u).then(function(e){var t=e.data,a=t.result.tossupValues.map(function(e){var n=e.tossup_value,t=e.tossup_answer_type;return{value:n,type:t}}).sort(function(e,n){return e.value-n.value}),o={tossupValues:a,partsPerBonus:t.result.partsPerBonus,bonusPointValue:t.result.bonusPointValue};angular.copy(o,i.tournamentFactory.pointScheme),n()}).catch(function(e){return s(e)})})}var i=this,c={tossupValues:[]},m={},l={bouncebacks:!1,maxActive:4};return i.tournamentFactory={rules:l,activePhase:m,pointScheme:c,getTournamentContext:a,edit:o,addPointValue:r,postPointValues:u,updateRules:s},i.tournamentFactory}])}(),function(){angular.module("statsApp").factory("Stats",["$http","$q","Cookies",function(e,n,t){function a(t){var a=arguments.length<=1||void 0===arguments[1]?null:arguments[1];return n(function(n,o){e.get("/api/t/"+t+"/stats/player"+(a?"?phase="+a:"")).then(function(e){var t=e.data;t.result.stats.forEach(function(e){e.pointMap=e.tossup_totals.reduce(function(e,n){return e[n.value]=n.total,e},{})}),angular.copy({id:t.result.activePhaseId},d.factory.activePhase),angular.copy(t.result.stats,d.factory.playerStats),angular.copy(t.result.pointScheme,d.factory.pointScheme),angular.copy({name:t.result.tournamentName},d.factory.tournamentName),n(t.result)}).catch(function(e){return o(e)})})}function o(t){var a=arguments.length<=1||void 0===arguments[1]?null:arguments[1];return n(function(n,o){e.get("/api/t/"+t+"/stats/team"+(a?"?phase="+a:"")).then(function(e){var t=e.data;t.result.stats.forEach(function(e){e.pointMap=e.tossup_totals.reduce(function(e,n){return e[n.value]=n.total,e},{})}),angular.copy(t.result.divisions,d.factory.divisions),angular.copy(t.result.stats,d.factory.teamStats),m(t.result.stats,t.result.divisions),n(t.result)}).catch(function(e){return o(e)})})}function s(t){var a=arguments.length<=1||void 0===arguments[1]?null:arguments[1];return n(function(n,o){e.get("/api/t/"+t+"/stats/teamfull"+(a?"?phase="+a:"")).then(function(e){var t=e.data;t.result.stats.forEach(function(e){e.matches.forEach(function(e){e.pointMap=e.tossup_totals.reduce(function(e,n){return e[n.value]=n.total,e},{})})}),angular.copy(t.result.stats,d.factory.teamFullStats),n()}).catch(function(e){return o(e)})})}function r(t){var a=arguments.length<=1||void 0===arguments[1]?null:arguments[1];return n(function(n,o){e.get("/api/t/"+t+"/stats/playerfull"+(a?"?phase="+a:"")).then(function(e){var t=e.data;t.result.stats.forEach(function(e){e.matches.forEach(function(e){e.pointMap=e.tossup_totals.reduce(function(e,n){return e[n.value]=n.total,e},{})})}),angular.copy(t.result.stats,d.factory.playerFullStats),n()}).catch(function(e){return o(e)})})}function u(t){var a=arguments.length<=1||void 0===arguments[1]?null:arguments[1];return n(function(n,o){e.get("/api/t/"+t+"/stats/roundreport"+(a?"?phase="+a:"")).then(function(e){var t=e.data;angular.copy(t.result.stats,d.factory.roundReportStats),n()}).catch(function(e){return o(e)})})}function i(a,o){var s=o.download,r=void 0!==s&&s,u=o.fileName,i=void 0===u?"qbj_file":u;return n(function(n,o){var s=t.get("nfToken");e.get("/api/t/"+a+"/qbj?token="+s).then(function(e){var t=e.data;r&&l(t.result,i),n()}).catch(function(e){return o(e)})})}function c(e,t){return n(function(i,c){n.all([a(e,t),o(e,t),s(e,t),r(e,t),u(e,t)]).then(function(){return i()}).catch(function(e){return c(e)})})}function m(e,n){var t=[];n.length>0&&(t=e.filter(function(e){return null===e.division_id})),angular.copy(t,d.factory.unassignedTeams)}function l(e,n){if(window.navigator.msSaveOrOpenBlob){var t=[JSON.stringify(e,null,4)],a=new Blob(t);window.navigator.msSaveOrOpenBlob(a,n+".qbj")}else{var o;!function(){var t="json",a=new Blob([JSON.stringify(e,null,4)],{type:t}),s=window.URL||window.webkitURL,r=s.createObjectURL(a);o=document.createElement("a"),"undefined"==typeof o.download?window.location=r:(o.href=r,o.download=n+".qbj",document.body.appendChild(o),o.click(),setTimeout(function(){document.body.removeChild(o),window.URL.revokeObjectURL(r)},100))}()}}var d=this;return d.factory={refreshStats:c,getQBJReport:i,playerStats:[],teamStats:[],teamFullStats:[],playerFullStats:[],roundReportStats:[],divisions:[],unassignedTeams:[],pointScheme:[],tournamentName:{},activePhase:{}},d.factory}])}();