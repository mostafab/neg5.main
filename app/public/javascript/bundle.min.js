"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var n=0,t=Array(e.length);n<e.length;n++)t[n]=e[n];return t}return Array.from(e)}!function(){angular.module("tournamentApp",["ngCookies","ngAnimate"]).config(["$animateProvider",function(e){e.classNameFilter(/angular-animate/)}])}(),function(){angular.module("HomeApp",["ngCookies","ngAnimate"]).config(["$animateProvider",function(e){e.classNameFilter(/angular-animate/)}]),angular.module("HomeApp").controller("HomeController",["$cookies","$scope","$http","$timeout","$window",function(e,n,t,a,o){var r=this;n.toastMessage=null;var s=3e3,u=null;n.toast=function(e){var t=e.message,o=e.success,r=void 0===o?null:o,i=e.hideAfter,c=void 0!==i&&i;c&&(u&&a.cancel(u),u=a(function(){n.toastMessage=null,u=null},s)),n.toastMessage={message:t,success:r}},r.tournaments=[],r.submittingForm=!1,r.getTournaments=function(){var n=e.get("nfToken");t.get("/api/t?token="+n).then(function(e){var n=e.data;r.tournaments=n.data}).catch(function(e){return console.log(e)})},r.createNewTournament=function(){r.newTournamentForm.$valid&&!function(){var a={token:e.get("nfToken"),name:r.newTournament.name},o={message:"Adding tournament: "+r.newTournament.name};n.toast(o),r.submittingForm=!0,t.post("/api/t",a).then(function(e){var n=e.data,t=n.result.tournament;r.getTournaments(),r.newTournament={},o.success=!0,o.message="Added tournament: "+t.name}).catch(function(e){o.success=!1,o.message="Could not add tournament."}).finally(function(){o.hideAfter=!0,r.submittingForm=!1,n.toast(o)})}()},r.newTournament={},n.logout=function(){e.remove("nfToken"),o.location="/"},r.getTournaments()}])}(),function(){function e(e,t,a,o,r,s){var u=this,i=n(t);u.toastMessage=null,u.phases=o.phases,u.divisions=r.divisions,u.unassignedTeams=r.unassignedTeams,u.phase=null,u.playerStats=r.playerStats,u.teamStats=r.teamStats,u.teamFullStats=r.teamFullStats,u.playerFullStats=r.playerFullStats,u.roundReportStats=r.roundReportStats,u.pointScheme=r.pointScheme,u.tournamentName=r.tournamentName,u.tab=function(){var e=s.get("nfStatsTab")||"team_standings";return e}(),u.activePhase=r.activePhase,u.toast=function(e){var n=e.message,t=e.success,o=void 0===t?null:t,r=e.hideAfter,s=void 0!==r&&r;s&&a(function(){u.toastMessage=null},2500),u.toastMessage={message:n,success:o}},e.$watch(angular.bind(u,function(){return u.tab}),function(e){s.set("nfStatsTab",e)}),u.refreshStats=function(){var e={message:"Refreshing stats."};u.toast(e),r.refreshStats(i,u.phase?u.phase.id:null).then(function(){e.message="Loaded stats for "+(u.phase?u.phase.name+".":"all games."),e.success=!0}).catch(function(){e.message="Could not reload stats.",e.success=!1}).finally(function(){e.hideAfter=!0,u.toast(e)})},u.setHashLocation=function(e){a(function(){t.location.hash="#"+e},50)},o.getPhases(i).then(function(){return u.refreshStats()})}function n(e){return e.location.pathname.split("/")[2]}angular.module("statsApp",["ngCookies","ngAnimate","tournamentApp"]).config(["$animateProvider",function(e){e.classNameFilter(/angular-animate/)}]),angular.module("statsApp").controller("PublicStatsController",["$scope","$window","$timeout","Phase","Stats","Cookies",e])}(),function(){function e(e,n,t){var a=this;a.searchQuery="",a.searchResults=[],a.timeoutRequest=null,a.collaborators=t.collaborators,a.getCollaborators=function(){return t.getCollaborators(e.tournamentId)},a.getKeyPress=function(e){a.searchQuery.trim().length>=2&&(a.timeoutRequest&&n.cancel(a.timeoutRequest),a.timeoutRequest=n(function(){a.findUsers(),a.timeoutRequest=null},333))},a.findUsers=function(){a.searchQuery.trim().length>0&&t.findUsers(a.searchQuery).then(function(e){var n=e.users;return a.searchResults=n}).catch(function(e){return console.log(e)})},a.addCollaborator=function(n){var r=!(arguments.length<=1||void 0===arguments[1])&&arguments[1],s={message:"Adding "+n};e.toast(s),t.postCollaborator(e.tournamentId,n,r).then(function(){o(n),a.getCollaborators(),s.message="Added "+n,s.success=!0}).catch(function(e){s.message="Could not add "+n,s.success=!1}).finally(function(){s.hideAfter=!0,e.toast(s)})},a.toggleAdmin=function(n){t.updateCollaborator(e.tournamentId,n.username,!n.admin).catch(function(n){e.toast({message:"Could not change permissions",success:!1,hideAfter:!0})})};var o=function(e){for(var n=0;a.searchResults[n]&&a.searchResults[n].username!==e;)n++;a.searchResults.splice(n,1)};a.removeCollaborator=function(n){return t.deleteCollaborator(e.tournamentId,n)},a.getCollaborators()}angular.module("tournamentApp").controller("CollabCtrl",["$scope","$timeout","Collaborator",e])}(),function(){function e(e,n,t,a,o,r){var s=this;s.editingPointScheme=!1,s.editingRules=!1,s.pointScheme=t.pointScheme,s.rules=t.rules,s.rulesCopy={},s.pointSchemeCopy={tossupValues:[]},s.newPointValue={type:null},s.newDivision={name:""},s.games=a.games,s.divisions=o.divisions,s.phases=r.phases,s.resetPointSchemeCopyToOriginal=function(){angular.copy(s.pointScheme,s.pointSchemeCopy),s.pointSchemeCopy.tossupValues.sort(function(e,n){return e.value-n.value})},s.resetRules=function(){angular.copy(s.rules,s.rulesCopy)},s.saveRules=function(){var n=angular.equals(s.rulesCopy,s.rules);!n&&s.editConfigurationRules.$valid?!function(){var n={message:"Updating rules."};t.updateRules(e.tournamentId,s.rulesCopy).then(function(){s.resetRules(),n.message="Updated rules",n.success=!0,s.editingRules=!1}).catch(function(){n.message="Could not update rules",n.success=!1}).finally(function(){n.hideAfter=!0,e.toast(n)})}():n&&s.editConfigurationRules.$valid&&(s.editingRules=!1)},s.editPointScheme=function(){!u()&&s.editPointSchemeForm.$valid&&!function(){var n={message:"Saving point values"};e.toast(n),t.postPointValues(e.tournamentId,s.pointSchemeCopy).then(function(){s.resetPointSchemeCopyToOriginal(),s.editingPointScheme=!1,n.message="Saved point values",n.success=!0}).catch(function(e){n.message="Could not save point values",n.success=!1}).finally(function(){n.hideAfter=!0,e.toast(n)})}()},s.addNewPointValue=function(){s.newPointValue.type&&s.newPointValue.value&&s.newPointValueForm.$valid&&!function(){var n={message:"Adding point value"};e.toast(n),t.addPointValue(e.tournamentId,s.newPointValue).then(function(e){s.resetPointSchemeCopyToOriginal(),n.message="Added point value",n.success=!0,s.newPointValue={}}).catch(function(e){n.message="Could not add point value",n.success=!1}).finally(function(){n.hideAfter=!0,e.toast(n)})}()},s.removeFromPointSchemeCopy=function(e){s.pointSchemeCopy.tossupValues=s.pointSchemeCopy.tossupValues.filter(function(n){return n!==e})},s.saveDivision=function(n){var t=n.newName.trim();n.name.trim()!==t&&0!==t.length?!function(){var t={message:"Saving division."},a=n.name;e.toast(t),o.editDivision(e.tournamentId,n).then(function(e){t.success=!0,t.message="Changed division: "+a+" → "+e}).catch(function(e){t.success=!1,t.message="Could not update division."}).finally(function(){t.hideAfter=!0,e.toast(t),n.editing=!1})}():n.editing=!1},s.addNewDivision=function(){var n=s.newDivision.name.trim();n.length>0&&s.newDivision.phaseId&&!function(){var t={message:"Adding division"};e.toast(t),o.addDivision(e.tournamentId,n,s.newDivision.phaseId).then(function(e){t.message="Added division: "+e,t.success=!0,s.resetNewDivision()}).catch(function(e){t.message="Could not add division",t.success=!1}).finally(function(){t.hideAfter=!0,e.toast(t)})}()},s.removeDivision=function(n){var t={message:"Removing division."};e.toast(t),o.removeDivision(e.tournamentId,n).then(function(){t.message="Removed division.",t.success=!0}).catch(function(){t.message="Could not remove division",t.success=!1}).finally(function(){t.hideAfter=!0,e.toast(t)})},s.resetNewDivision=function(){return s.newDivision.name=""};var u=function(){for(var e={},n=0;n<s.pointSchemeCopy.tossupValues.length;n++){if(e[s.pointSchemeCopy.tossupValues[n].value])return!0;e[s.pointSchemeCopy.tossupValues[n].value]=!0}return!1};n(function(){s.resetPointSchemeCopyToOriginal(),s.resetRules()},500),o.getDivisions(e.tournamentId)}angular.module("tournamentApp").controller("ConfigCtrl",["$scope","$timeout","Tournament","Game","Division","Phase",e])}(),function(){function e(e,n,t,a,o,r,s){function u(e){if(!e||!e.players)return 0;var n=e.players.map(function(e){var n=0;for(var t in e.points)e.points.hasOwnProperty(t)&&t>0&&(n+=e.points[t]);return n}).reduce(function(e,n){return e+n},0);return n}function i(){return{teams:[{teamInfo:null,players:[],overtime:0},{teamInfo:null,players:[],overtime:0}],phases:[],round:1,tuh:20,room:null,moderator:null,packet:null,notes:null}}function c(){d.currentGame=d.resetCurrentGame(),d.newGameForm.$setUntouched()}function m(e,n){var t=e.phases.reduce(function(e,n){return e[n.id]=!0,e},{});return n.filter(function(e){return t[e.id]===!0})}function l(e,n){e.teams.forEach(function(e){var t=n.findIndex(function(n){return n.id===e.id});t!==-1&&(e.teamInfo=n[t])})}var d=this;d.teams=n.teams,d.games=t.games,d.phases=a.phases,d.sortType="round",d.sortReverse=!1,d.gameQuery="",d.pointScheme=o.pointScheme,d.rules=o.rules,d.pointSum=function(e){if(!e)return 0;var n=Object.keys(e);return n.reduce(function(n,t){var a=e[t+""]*t||0;return n+a},0)},d.teamBonusPoints=function(e){if(!e)return 0;var n=e.players.map(function(e){return d.pointSum(e.points)}).reduce(function(e,n){return e+n},0);return(e.score||0)-n-(e.bouncebacks||0)},d.teamPPB=function(e){if(!e)return 0;if(0===e.players.length)return 0;var n=u(e)-(e.overtime||0),t=d.teamBonusPoints(e);return t/n||0},d.isValidPPB=function(e){var n=d.pointScheme,t=n.partsPerBonus,a=n.bonusPointValue;return e>=0&&e<=t*a},d.isValidScore=function(){var e=arguments.length<=0||void 0===arguments[0]?0:arguments[0],n=[].concat(_toConsumableArray(d.pointScheme.tossupValues.map(function(e){return e.value})),[d.pointScheme.bonusPointValue]).filter(function(e){return void 0!==e}).map(function(e){return Math.abs(e)}),t=r.arrayUnique(n,function(e){return e});if(0===t.length)return!0;var a=s.gcdArray(t);return Math.abs(e)%a===0},d.totalTeamTossupGets=u,d.currentGame=i(),d.loadedGame={},d.loadedGameOriginal={},d.addTeam=function(n){var a={message:"Loading "+n.teamInfo.name+" players."};e.toast(a),t.getTeamPlayers(e.tournamentId,n.teamInfo.id).then(function(e){n.players=e.map(function(e){var n=e.name,t=e.id;return{id:t,name:n,points:d.pointScheme.tossupValues.reduce(function(e,n){return e[n.value]=0,e},{}),tuh:d.currentGame.tuh}}),a.success=!0,a.message="Loaded "+n.teamInfo.name+" players ("+n.players.length+")"}).catch(function(e){a.success=!1,a.message="Could not load team."}).finally(function(){a.hideAfter=!0,e.toast(a)})},d.getGames=function(){return t.getGames(e.tournamentId)},d.resetForm=c,d.addGame=function(){d.newGameForm.$valid&&!function(){var n={message:"Adding match."};e.toast(n),t.postGame(e.tournamentId,d.currentGame).then(function(){d.resetForm(),d.getGames(),n.success=!0,n.message="Added match"}).catch(function(e){n.success=!1,n.message="Could not add match"}).finally(function(){n.hideAfter=!0,e.toast(n)})}()},d.loadGame=function(n){var a={message:"Loading game."};e.toast(a),t.getGameById(e.tournamentId,n).then(function(e){e.phases=m(e,d.phases),l(e,d.teams),angular.copy(e,d.loadedGame),angular.copy(d.loadedGame,d.loadedGameOriginal),a.message="Loaded game",a.success=!0}).catch(function(e){a.message="Could not load game",a.success=!1}).finally(function(){a.hideAfter=!0,e.toast(a)})},d.resetLoadedGame=function(){return angular.copy(d.loadedGameOriginal,d.loadedGame)},d.editLoadedGame=function(){d.editGameForm.$valid&&!function(){var n={message:"Editing match."};e.toast(n),t.editGame(e.tournamentId,d.loadedGame.id,d.loadedGame).then(function(){d.loadedGame.editing=!1,d.getGames(),n.message="Edited match.",n.success=!0}).catch(function(e){n.message="Could not edit match",n.success=!1}).finally(function(){n.hideAfter=!0,e.toast(n)})}()},d.deleteGame=function(n){n&&!function(){var a={message:"Deleting match."};e.toast(a),t.deleteGame(e.tournamentId,n).then(function(){d.loadedGame={},a.message="Deleted match.",a.success=!0}).catch(function(e){a.message="Could not delete match.",a.success=!1}).finally(function(){a.hideAfter=!0,e.toast(a)})}()},d.resetCurrentGame=i,d.numPlayerAnswers=function(e){var n=!(arguments.length<=1||void 0===arguments[1])&&arguments[1],t=0;for(var a in e.points)e.points.hasOwnProperty(a)&&(a>=0||!n)&&(t+=e.points[a]||0);return t},d.minPossibleTossupsHeard=function(e){var n=e.teams?e.teams.reduce(function(e,n){var t=n.players.reduce(function(e,n){return e+d.numPlayerAnswers(n,!0)},0);return e+t},0):0,t=e.teams?e.teams.reduce(function(e,n){var t=n.players.reduce(function(e,n){var t=0;for(var a in n.points)n.points.hasOwnProperty(a)&&a<0&&(t+=n.points[a]);return e+t},0);return e+=t},0):0;if(t>n){var a=t-n;return a+n}return n},d.matchSearch=function(e){var n=d.gameQuery.toLowerCase(),t=(e.round,e.teams),a=t.one.name.toLowerCase(),o=t.two.name.toLowerCase();return e.round==n||a.indexOf(n)!==-1||o.indexOf(n)!==-1},d.getGames()}angular.module("tournamentApp").filter("preventSameMatchTeams",function(){return function(e,n){return e.filter(function(e){return e.id!==n})}}),angular.module("tournamentApp").controller("GameCtrl",["$scope","Team","Game","Phase","Tournament","ArrayUtil","MathUtil",e])}(),function(){function e(e,n){var t=this;t.phases=n.phases,t.newPhase="",t.activePhase=n.activePhase,t.getPhases=function(){return n.getPhases(e.tournamentId)},t.addPhase=function(){var a=t.newPhase.trim();t.isValidNewPhaseName(a)&&!function(){var o={message:"Adding phase."};e.toast(o),n.postPhase(e.tournamentId,a).then(function(e){t.newPhase="",o.success=!0,o.message="Added phase: "+e}).catch(function(e){o.success=!1,o.message="Couldn't add phase"}).finally(function(){o.hideAfter=!0,e.toast(o)})}()},t.removePhase=function(t){var a={message:"Deleting phase: "+t.name};e.toast(a),n.deletePhase(e.tournamentId,t.id).then(function(e){a.success=!0,a.message="Deleted phase: "+e}).catch(function(e){a.success=!1,a.message="Couldn't delete phase: "+t.name}).finally(function(){a.hideAfter=!0,e.toast(a)})},t.updateActivePhase=function(a){t.activePhase.id!==a.id&&n.updateActivePhase(e.tournamentId,a.id).catch(function(n){e.toast({message:"Could not change active phase to: "+a.name,success:!1,hideAfter:!0})})},t.editPhase=function(a){t.phaseNameWasChanged(a)?!function(){var t={message:"Editing phase."},o=a.name;e.toast(t),n.editPhase(e.tournamentId,a.newName.trim(),a.id).then(function(e){t.message="Updated phase: "+o+" → "+e,t.success=!0,a.newName=e,a.name=e,a.editing=!1}).catch(function(){t.message="Couldn't update phase",t.success=!1}).finally(function(){t.hideAfter=!0,e.toast(t)})}():a.editing=!1},t.phaseNameWasChanged=function(e){var n=e.newName.trim(),t=e.name.trim();return n!==t&&n.length>0},t.isValidNewPhaseName=function(e){return e=e.toLowerCase().trim(),e.length>0&&!t.phases.some(function(n){return n.name.toLowerCase()===e})},t.getPhases()}angular.module("tournamentApp").controller("PhaseCtrl",["$scope","Phase",e])}(),function(){function e(e,n,t,a,o,r){function s(){return{teams:[{teamInfo:null,players:[],newPlayer:"",overtime:0},{teamInfo:null,players:[],newPlayer:"",overtime:0}],cycles:d(20),currentCycle:{number:1,answers:[],bonuses:[]},onTossup:!0,round:0,packet:null,notes:null,moderator:null,phases:[],room:null}}function u(e){for(var n=[],t=0;t<e;t++)n[t]=void 0;return n}function i(e,n){return n.answers.findIndex(function(n){return n.teamId===e.id})===-1}function c(e){return e.answers.some(function(e){return"Neg"!==e.type})}function m(e,n){return n.answers.some(function(n){return n.teamId===e&&"Neg"!==n.type})}function l(e){p.game.teams.forEach(function(n){n.players.forEach(function(n){n.active&&n.tuh+e>=0&&(n.tuh+=e)})})}function d(e){for(var n=[],t=0;t<e;t++)n.push({answers:[],bonuses:[]});return n}function f(){p.game.lastSavedAt=new Date,r.localStorage.set("scoresheet_"+e.tournamentId,JSON.stringify(p.game))}var p=this;p.teams=t.teams,p.pointScheme=n.pointScheme,p.rules=n.rules,p.phases=a.phases,p.game=s(),p.newScoresheet=s,p.loadTeamPlayers=function(n){var a=n.teamInfo,o=a.id,r=a.name,s={message:"Loading "+r+" players."};e.toast(s),t.getTeamById(e.tournamentId,o).then(function(e){var t=e.players;n.players=t,n.players.forEach(function(e,n){e.active=n<p.rules.maxActive,e.tuh=0}),s.message="Loaded "+r+" players.",s.success=!0}).catch(function(){s.message="Could not load "+r+" players.",s.success=!1}).finally(function(){s.hideAfter=!0,e.toast(s)})},p.addPlayer=function(n){n.newPlayer.length>0&&!function(){var a={message:"Adding "+n.newPlayer+" to "+n.teamInfo.name+"."};e.toast(a),t.addPlayer(e.tournamentId,n.teamInfo.id,n.newPlayer).then(function(e){n.players.push({name:e.name,id:e.id,tuh:0,active:n.players.length+1<=p.rules.maxActive}),n.newPlayer="",a.message="Added "+e.name+" to "+n.teamInfo.name+".",a.success=!0}).catch(function(){a.message="Could not add "+n.newPlayer+" to "+n.teamInfo.name,a.success=!1}).finally(function(){a.hideAfter=!0,e.toast(a)})}()},p.getNumberOfActivePlayers=function(e){return e.filter(function(e){return e.active}).length},p.getTeamBouncebacks=function(e){var n=0;if(p.game.cycles.forEach(function(t){if(!m(e,t)&&c(t)){var a=t.bonuses.filter(function(n){return n===e}).length;n+=a*p.pointScheme.bonusPointValue}}),!m(e,p.game.currentCycle)&&c(p.game.currentCycle)){var t=p.game.currentCycle.bonuses.filter(function(n){return n===e}).length;n+=t*p.pointScheme.bonusPointValue}return n},p.range=function(e){return new Array(e)},p.swapPlayers=function(e,n,t){t<0?t=e.length-1:t===e.length&&(t=0);var a=[];angular.copy(e,a);var o=e[n];a[n]=a[t],a[t]=o,angular.copy(a,e)},p.getNumberOfAnswersForPlayer=function(e){return p.game.cycles.reduce(function(n,t){var a=t.answers.some(function(n){return n.playerId===e.id});return n+(a?1:0)},0)},p.setTeamThatGotBonusPartCurrentCycle=function(e,n,t){t[e]=t[e]===n.id?null:n.id},p.getTeamThatGotTossup=function(e){var n=e.answers.findIndex(function(e){return"Neg"!==e.type});return n===-1?null:e.answers[n].teamId},p.getTeamBonusPointsForCycle=function(e,n){var t=n+1===p.game.currentCycle.number?p.game.currentCycle:p.game.cycles[n];return t.bonuses.filter(function(n){return n===e}).length*p.pointScheme.bonusPointValue},p.getTeamScoreUpToCycle=function(e,n){for(var t=0,a=0;a<=n;a++){var o=p.game.cycles[a];o.answers.forEach(function(n){n.teamId===e&&(t+=n.value)}),t+=o.bonuses.filter(function(n){return n===e}).length*p.pointScheme.bonusPointValue}return n+1===p.game.currentCycle.number&&(p.game.currentCycle.answers.forEach(function(n){n.teamId===e&&(t+=n.value)}),t+=p.game.currentCycle.bonuses.filter(function(n){return n===e}).length*p.pointScheme.bonusPointValue),t},p.nextCycle=function(){var e=p.game.currentCycle.number+1,n=p.game.currentCycle.number-1;n>=p.game.cycles.length-1&&p.game.cycles.push({answers:[],bonuses:[]}),angular.copy(p.game.currentCycle.answers,p.game.cycles[n].answers),angular.copy(p.game.currentCycle.bonuses,p.game.cycles[n].bonuses),p.game.currentCycle={number:e,answers:[],bonuses:[]},l(1),f()},p.lastCycle=function(){if(p.game.currentCycle.number>1){var e=p.game.currentCycle.number-1;p.game.cycles[e]={answers:[],bonuses:[]},p.game.cycles[e-1].bonuses=[],p.game.cycles[e-1].answers=[],p.game.currentCycle={answers:[],bonuses:[],number:p.game.currentCycle.number-1}}l(-1),f()},p.getPlayerAnswerForCycle=function(e,n){return n.answers.find(function(n){return n.playerId===e.id})},p.addPlayerAnswerToCurrentCycle=function(e,n,t){i(n,p.game.currentCycle)&&p.game.currentCycle.answers.push({playerId:e.id,teamId:n.id,value:t.value,type:t.type})},p.getNumberOfTossupTypeForPlayer=function(e,n){var t=p.game.cycles.reduce(function(t,a){var o=a.answers.filter(function(t){return t.playerId===e.id&&t.value===n.value}).length;return t+o},0),a=p.game.currentCycle.answers.filter(function(t){return t.playerId===e.id&&t.type===n.type}).length;return t+a},p.getPlayerTotalPoints=function(e){var n=0;return p.pointScheme.tossupValues.forEach(function(t){var a=p.getNumberOfTossupTypeForPlayer(e,t);n+=a*t.value}),n},p.switchToBonusIfTossupGotten=function(e,n){"Neg"!==e.type&&p.teamDidNotNegInCycle(n,p.game.currentCycle)&&p.switchCurrentCycleContext(!0)},p.removeLastAnswerFromCycle=function(e){e.answers.pop(),e.bonuses=[]},p.getTeam=function(e){if(e)return p.game.teams.find(function(n){return n.teamInfo.id===e})},p.switchCurrentCycleContext=function(e){p.game.onTossup=!e},p.teamDidNotNegInCycle=function(e,n){return n.answers.findIndex(function(n){return"Neg"===n.type&&n.teamId===e})===-1},p.removeTeamNegsFromCycle=function(e,n){n.answers=n.answers.filter(function(n){return!("Neg"===n.type&&n.teamId===e)})},p.loadLastSavedScoresheet=function(){var n=r.localStorage.get("scoresheet_"+e.tournamentId);if(n)try{p.game=JSON.parse(n),e.toast({message:"Loaded scoresheet.",success:!0,hideAfter:!0})}catch(n){e.toast({message:"Could not read scoresheet.",success:!1,hideAfter:!0})}else e.toast({message:"No prior saved scoresheet",success:!1,hideAfter:!0})},p.displayPlayerAnswerForCycle=function(e,n){var t=p.game.cycles[n];n<p.game.currentCycle.number-1&&!function(){t.editing||(t.editing={}),t.newAnswer||(t.newAnswer={});var n=p.getPlayerAnswerForCycle(e,t);n?t.newAnswer[e.id]=p.pointScheme.tossupValues.find(function(e){return e.value===n.value}):t.newAnswer[e.id]=null,t.editing[e.id]=!0}()},p.displayCycleBonuses=function(e,n){var t=p.game.cycles[n];n<p.game.currentCycle.number-1&&c(t)&&(t.bonusesCopy=[],angular.copy(t.bonuses,t.bonusesCopy),t.editingBonus=!0)},p.editPlayerAnswerForCycle=function(e,n,t,a){var o=void 0;o=t&&"Neg"!==t.type?function(e){return e.teamId!==n&&"Neg"===e.type}:function(e){return e.teamId!==n&&"Neg"!==e.type};var r=a.answers.filter(o);t&&r.push({playerId:e,teamId:n,value:t.value,type:t.type}),a.answers=r,c(a)||(a.bonuses=[]),a.editing||(a.editing={}),a.editing[e]=!1},p.editCycleBonuses=function(e){e.bonusesCopy&&(angular.copy(e.bonusesCopy,e.bonuses),e.editingBonus=!1)},p.submitScoresheet=function(){p.scoresheetForm.$valid?p.game.submitted?e.toast({message:"This match has already been submitted.",success:!1,hideAfter:!0}):!function(){var n=p.parseScoresheet(p.game),t={message:"Adding match."};e.toast(t),o.postGame(e.tournamentId,n).then(function(n){p.game.id=n[0].id,p.game.submitted=!0,f(),t.success=!0,t.message="Added match",o.getGames(e.tournamentId)}).catch(function(e){t.success=!1,t.message="Failed to add match."}).finally(function(){t.hideAfter=!0,e.toast(t)})}():e.toast({message:"Please fix the errors on the scoresheet.",success:!1,hideAfter:!0})},p.parseScoresheet=function(e){var n={moderator:e.moderator,notes:e.notes,packet:e.packet,phases:e.phases,room:e.room,round:e.round,tuh:e.currentCycle.number-1,teams:e.teams.map(function(n){return{teamInfo:n.teamInfo,players:n.players.filter(function(e){return e.tuh>0}).map(function(e){return{id:e.id,tuh:e.tuh,points:p.pointScheme.tossupValues.reduce(function(n,t){return n[t.value]=p.getNumberOfTossupTypeForPlayer(e,t),n},{})}}),score:p.getTeamScoreUpToCycle(n.teamInfo.id,e.currentCycle.number-1),bouncebacks:p.getTeamBouncebacks(n.teamInfo.id),overtime:n.overtime||0}}),scoresheet:e.cycles.filter(function(n,t){return t<e.currentCycle.number-1}).map(function(e,n){return{number:n+1,answers:e.answers,bonuses:u(p.pointScheme.partsPerBonus).map(function(n,t){return{part:t+1,teamThatGotBonus:e.bonuses[t]||null}})}})};return n},p.revertScoresheetSubmission=function(){var n=p.game.id;n&&!function(){var t={message:"Reverting submission."};e.toast(t),o.deleteGame(e.tournamentId,n).then(function(){p.game.id=null,p.game.submitted=!1,t.message="Reverted submission",t.success=!0}).catch(function(e){t.message="Could not revert submission",t.success=!1}).finally(function(){t.hideAfter=!0,e.toast(t)})}()}}angular.module("tournamentApp").controller("ScoresheetCtrl",["$scope","Tournament","Team","Phase","Game","Cookies",e])}(),function(){function e(e,n){var t=this;t.downloadQBJ=function(){var t={message:"Generating QBJ file."};e.toast(t),n.getQBJReport(e.tournamentId,{download:!0,fileName:e.tournamentInfo.name.toLowerCase().replace(/ /g,"_")}).then(function(){t.message="Generated QBJ file.",t.success=!0}).catch(function(){t.message="Could not download QBJ file.",t.success=!1}).finally(function(){t.hideAfter=!0,e.toast(t)})}}angular.module("tournamentApp").controller("StatisticsCtrl",["$scope","QBJ",e])}(),function(){function e(e,n,t,a,o,r){function s(){m.newTeam={name:"",players:[{name:""},{name:""},{name:""},{name:""}],divisions:{}}}function u(e){m.currentTeam.newName=e,m.currentTeam.name=e,m.currentTeam.editingName=!1}function i(e,n){e.name=n,e.newName=n,e.editing=!1}function c(e){var n=m.currentTeam.players.findIndex(function(n){return n.id===e});n!==-1&&m.currentTeam.players.splice(n,1)}var m=this;m.teams=t.teams,m.phases=a.phases,m.divisions=o.divisions;var l=r.games;m.newTeam={name:"",players:[{name:""},{name:""},{name:""},{name:""}],divisions:{}},m.currentTeam={},m.teamSortType="name",m.teamSortReverse=!1,m.teamQuery="",m.getTournamentTeams=function(){t.getTeams(e.tournamentId)},m.addPlayer=function(){return m.newTeam.players.push({name:""})},m.removePlayerSlot=function(e){return m.newTeam.players.splice(e,1)},m.addTeam=function(){m.newTeamForm.$valid&&!function(){var n={message:"Adding team."};e.toast(n),t.postTeam(e.tournamentId,m.newTeam).then(function(e){s(),n.message="Added team: "+e,n.success=!0}).catch(function(e){n.message="Could not add team.",n.success=!1}).finally(function(){n.hideAfter=!0,e.toast(n)})}()},m.findTeam=function(n){n.id!==m.currentTeam.id&&!function(){var a={message:"Loading Team: "+n.name};e.toast(a),t.getTeamById(e.tournamentId,n.id).then(function(e){angular.copy(e,m.currentTeam),a.success=!0,a.message="Loaded team: "+e.name}).catch(function(e){a.success=!1,a.message="Could not load team: "+n.name}).finally(function(){a.hideAfter=!0,e.toast(a)})}()},m.saveCurrentTeamName=function(){var n=m.currentTeam,a=n.id,o=n.name,r=n.newName;o!==r&&r.length>0?m.isUniqueTeamName(a,r)&&!function(){var n={message:"Editing team: "+o+" → "+r};e.toast(n),t.editTeamName(e.tournamentId,a,r).then(function(e){u(e),n.success=!0,n.message="Saved team name: "+o+" → "+e}).catch(function(e){n.success=!1,n.message="Could not update team name: "+o+" → "+r}).finally(function(){n.hideAfter=!0,e.toast(n)})}():m.currentTeam.editingName=!1},m.updateCurrentTeamDivisions=function(){var n=m.currentTeam.name,a={message:"Updating divisions for: "+m.currentTeam.name};e.toast(a);var o=Object.keys(m.currentTeam.mappedDivisions).map(function(e){return m.currentTeam.mappedDivisions[e]});t.updateTeamDivisions(e.tournamentId,m.currentTeam.id,m.currentTeam.mappedDivisions,o).then(function(){a.success=!0,a.message="Updated divisions for: "+n}).catch(function(){a.success=!1,a.message="Could not update divisions for: "+n}).finally(function(){a.hideAfter=!0,e.toast(a)})},m.savePlayerNameOnCurrentTeam=function(n){var a=n.name,o=n.newName,r=n.id;a!==o&&o.length>0?m.isUniqueTeamPlayerName(r,o)&&!function(){var s={message:"Editing player: "+a+" → "+o};e.toast(s),t.editTeamPlayerName(e.tournamentId,r,o).then(function(e){i(n,e),s.success=!0,s.message="Saved player name: "+a+" → "+e}).catch(function(e){s.success=!1,s.message="Could not update player name: "+a+" → "+savedName}).finally(function(){s.hideAfter=!0,e.toast(s)})}():n.editing=!1},m.addTeamPlayer=function(){var n=m.currentTeam,a=n.newPlayer,o=n.id,r=n.name;a.length>0&&m.isUniqueTeamPlayerName(null,a)&&!function(){var n={message:"Adding player: "+a+" to "+r+"."};e.toast(n),t.addPlayer(e.tournamentId,o,a).then(function(e){m.currentTeam.players.push({id:e.id,name:e.name,newName:e.name,editing:!1,addedBy:e.added_by,games:0}),m.currentTeam.newPlayer="",n.success=!0,n.message="Added player: "+e.name+" to "+r}).catch(function(e){n.success=!1,n.message="Could not add player: "+player.name+" to "+r}).finally(function(){n.hideAfter=!0,e.toast(n)})}()},m.removeCurrentTeamPlayer=function(n){var a={message:"Deleting player: "+n.name};e.toast(a),t.deletePlayer(e.tournamentId,n.id).then(function(e){c(e),a.success=!0,a.message="Deleted player: "+n.name}).catch(function(e){a.success=!1,a.message="Could not delete "+n.name+" because this player has games played"}).finally(function(){a.hideAfter=!0,e.toast(a)})},m.removeCurrentTeam=function(){var n=m.currentTeam,a=n.id,o=n.name,r={message:"Deleting team: "+o};e.toast(r),t.deleteTeam(e.tournamentId,a).then(function(){r.success=!0,r.message="Deleted team: "+o,m.currentTeam={}}).catch(function(e){r.success=!1,r.message="Could not delete "+o+" because this team has games played."}).finally(function(){r.hideAfter=!0,e.toast(r)})},m.getDivisionNameInPhase=function(e){if(!e)return"";var n=m.divisions.find(function(n){return n.id===e});return n?n.name:""},m.teamHasPlayedNoGames=function(e){return!l.some(function(n){return n.teams.one.id===e||n.teams.two.id===e})},m.isUniqueTeamName=function(e,n){var t=n.trim().toLowerCase();return!m.teams.some(function(n){return n.id!==e&&n.name.trim().toLowerCase()===t})},m.isUniqueTeamPlayerName=function(e,n){var t=n.trim().toLowerCase();return!m.currentTeam.players.some(function(n){return n.id!==e&&n.name.trim().toLowerCase()===t})},m.getTournamentTeams()}angular.module("tournamentApp").controller("TeamCtrl",["$scope","$http","Team","Phase","Division","Game",e])}(),function(){function e(e,n,t,a,o,r,s,u,i){e.tournamentId=t.location.pathname.split("/")[2],e.tournamentContext={admin:!1,owner:!1},e.tournamentInfo={name:"",hidden:!1},e.toastMessage=null;var c=3e3,m=null;e.toast=function(n){var t=n.message,o=n.success,r=void 0===o?null:o,s=n.hideAfter,u=void 0!==s&&s;u&&(m&&a.cancel(m),m=a(function(){e.toastMessage=null,m=null},c)),e.toastMessage={message:t,success:r}};var l=this;l.tab=i.get("nfTab")||"overview",l.matchTab=i.get("nfMatchTab")||"add",l.teamTab=i.get("nfTeamTab")||"add",l.tournamentInfoCopy={},l.teams=r.teams,l.games=s.games,l.editing=!1,l.resetOverview=function(){angular.copy(e.tournamentInfo,l.tournamentInfoCopy)},l.editTournament=function(){l.editTournamentForm.$valid&&!function(){var n={message:"Editing tournament"};e.toast(n),u.edit(e.tournamentId,l.tournamentInfoCopy).then(function(e){d(e),l.resetOverview(),l.editing=!1,n.message="Edited tournament.",n.success=!0}).catch(function(e){n.message="Failed to update tournament.",n.success=!1}).finally(function(){n.hideAfter=!0,e.toast(n)})}()};var d=function(n){angular.copy(n,e.tournamentInfo)},f=function(){u.getTournamentContext(e.tournamentId).then(function(n){var t=n.tournamentInfo,a=n.tournamentContext;e.tournamentInfo=t,e.tournamentContext=a,angular.copy(e.tournamentInfo,l.tournamentInfoCopy)}).catch(function(e){console.log(e)})},p=function(){e.$watch(angular.bind(l,function(){return l.tab}),function(e){i.set("nfTab",e)}),e.$watch(angular.bind(l,function(){return l.matchTab}),function(e){i.set("nfMatchTab",e)}),e.$watch(angular.bind(l,function(){return l.teamTab}),function(e){i.set("nfTeamTab",e)})};e.logout=function(){o.remove("nfToken",{path:"/"}),t.location="/"},p(),f()}angular.module("tournamentApp").controller("TournamentCtrl",["$scope","$http","$window","$timeout","$cookies","Team","Game","Tournament","Cookies",e])}(),function(){angular.module("tournamentApp").factory("ArrayUtil",[function(){var e=function(e){var n=arguments.length<=1||void 0===arguments[1]?function(e,n,t){return e}:arguments[1];if(!e||!n)throw new Error("Invalid params: "+e+", "+n);if("function"!=typeof n)throw new Error("Invalid func parameter: "+n);if(!Array.isArray(e))throw new Error("Invalid arr parameter: "+e);var t=new Set,a=[];return e.forEach(function(e,o){var r=n(e,o);t.has(r)||(a.push(e),t.add(r))}),a},n=function(e){var n=arguments.length<=1||void 0===arguments[1]?function(e,n,t){return e}:arguments[1];if(!e||!n)throw new Error("Invalid params: "+e+", "+n);if("function"!=typeof n)throw new Error("Invalid func parameter: "+n);if(!Array.isArray(e)||0===e.length)throw new Error("Invalid arr parameter: "+e);return e.reduce(function(e,t,a,o){var r=n(t,a,o);return r>e?r:e;
},n(e[0]))};return{arrayUnique:e,arrayMax:n}}])}(),function(){angular.module("tournamentApp").factory("MathUtil",[function(){var e=function e(n,t){return 0===t?Math.abs(n):e(t,n%t)},n=function(n){if(!n||!Array.isArray(n))throw new Error("Invalid parameter: "+n);if(0===n.length)throw new Error("Empty array given.");for(var t=Math.abs(n[0]),a=0;a<n.length-1;a++)t=e(t,n[a+1]);return t};return{gcd:e,gcdArray:n}}])}(),function(){angular.module("statsApp").directive("keepNameScroll",function(){var e=function(e,n,t){var a=angular.element(n);a.on("scroll",function(){var e=a.scrollLeft();e>30?a.attr("data-keep-name","1"):a.attr("data-keep-name","0")})};return{restrict:"A",link:e}})}(),function(){angular.module("tournamentApp").factory("Collaborator",["$http","$q","Cookies",function(e,n,t){function a(a,o,r){return n(function(n,s){var u=t.get("nfToken"),i={username:o,token:u,admin:r};e.post("/api/t/"+a+"/collaborators",i).then(function(e){var t=e.data,a={name:t.result.name,username:t.result.username,admin:t.result.is_admin};c.collaboratorFactory.collaborators.push(a),n()}).catch(function(e){s(e)})})}function o(n){var a=t.get("nfToken");e.get("/api/t/"+n+"/collaborators?token="+a).then(function(e){var n=e.data,t=n.result.map(function(e){var n=e.name,t=e.username,a=e.is_admin;return{name:n,username:t,admin:a}});angular.copy(t,c.collaboratorFactory.collaborators)}).catch(function(e){return console.log(e)})}function r(a,o,r){return n(function(n,s){var u=t.get("nfToken"),i={admin:r,token:u};e.put("/api/t/"+a+"/collaborators/"+o,i).then(function(e){var t=e.data;c.collaboratorFactory.collaborators.find(function(e){return e.username===t.result.username}).admin=t.result.is_admin,n()}).catch(function(e){s(e)})})}function s(a){return n(function(n,o){var r=t.get("nfToken");e({url:"/api/users?token="+r+"&search="+a,method:"GET"}).then(function(e){var t=e.data,a=t.users.filter(function(e){return e.username!==t.currentUser});n({users:a})}).catch(function(e){return o(e)})})}function u(a,o){return n(function(n,r){var s=t.get("nfToken");e.delete("/api/t/"+a+"/collaborators/"+o+"?token="+s).then(function(e){var t=e.data;i(t.result.username),n()}).catch(function(e){return r(e)})})}function i(e){var n=c.collaboratorFactory.collaborators.findIndex(function(n){return n.username===e});c.collaboratorFactory.collaborators.splice(n,1)}var c=this,m=[];return c.collaboratorFactory={collaborators:m,getCollaborators:o,deleteCollaborator:u,postCollaborator:a,updateCollaborator:r,findUsers:s},c.collaboratorFactory}])}(),function(){angular.module("tournamentApp").factory("Cookies",["$cookies",function(e){function n(n){return e.get(n)}function t(n){return e.getObject(n)}function a(n,t){e.put(n,t)}function o(n){console.log(e.get(n)),e.remove(n),console.log(e.get(n))}function r(n,t){e.putObject(n,t)}function s(){return{set:function(e,n){localStorage.setItem(e,n)},get:function(e){return localStorage.getItem(e)}}}var u=this;return u.cookieFactory={get:n,set:a,remove:o,getObject:t,setObject:r,localStorage:s()},u.cookieFactory}])}(),function(){angular.module("tournamentApp").factory("Division",["$q","$http","Cookies",function(e,n,t){function a(a){return e(function(e,o){var r=t.get("nfToken");n.get("/api/t/"+a+"/divisions?token="+r).then(function(n){var t=n.data,a=t.result.map(function(e){return{name:e.division_name,newName:e.division_name,id:e.division_id,phaseId:e.phase_id}});angular.copy(a,m.factory.divisions),e()}).catch(function(e){o(e)})})}function o(a,o){return e(function(e,r){var s={token:t.get("nfToken"),newName:o.newName};n.put("/api/t/"+a+"/divisions/"+o.id,s).then(function(n){var t=n.data;u(t.result),e(t.result.name)}).catch(function(e){r(e)})})}function r(a,o,r){return e(function(e,s){var u={token:t.get("nfToken"),name:o,phaseId:r};n.post("/api/t/"+a+"/divisions",u).then(function(n){var t=n.data;i(t.result),e(t.result.name)}).catch(function(e){return s(e)})})}function s(a,o){var r=o.id;return e(function(e,o){var s=t.get("nfToken");n.delete("/api/t/"+a+"/divisions/"+r+"?token="+s).then(function(n){var t=n.data;c(t.result.id),e()}).catch(function(e){o(e)})})}function u(e){var n=m.factory.divisions.findIndex(function(n){return n.id===e.id});m.factory.divisions[n].name=e.name,m.factory.divisions[n].newName=e.name}function i(e){var n=e.name,t=e.id,a=e.phase_id;m.factory.divisions.push({name:n,newName:n,id:t,phaseId:a})}function c(e){var n=m.factory.divisions.findIndex(function(n){return n.id===e});n!==-1&&m.factory.divisions.splice(n,1)}var m=this,l=[];return m.factory={getDivisions:a,editDivision:o,addDivision:r,removeDivision:s,divisions:l},m.factory}])}(),function(){angular.module("tournamentApp").factory("Game",["$http","$q","Cookies",function(e,n,t){function a(a,o){var r=c(o);return n(function(n,o){var s={token:t.get("nfToken"),game:r};e.post("/api/t/"+a+"/matches",s).then(function(e){var t=e.data;n(t.result)}).catch(function(e){return o(e)})})}function o(n){var a=t.get("nfToken");e.get("/api/t/"+n+"/matches?token="+a).then(function(e){var n=e.data,t=n.matches.map(function(e){var n=e.match_id,t=e.tossups_heard,a=e.round,o=e.team_1_id,r=e.team_1_score,s=e.team_2_id,u=e.team_2_score,i=e.team_1_name,c=e.team_2_name,m=e.phases;return{id:n,tuh:t,round:a,teams:{one:{score:r,id:o,name:i},two:{score:u,id:s,name:c}},phases:m.reduce(function(e,n){return e[n.phase_id]=!0,e},{})}});angular.copy(t,l.gameFactory.games)})}function r(a,o){return n(function(n,r){var s=t.get("nfToken");e.get("/api/t/"+a+"/teams/"+o+"?token="+s).then(function(e){var t=e.data,a=t.result.players.map(function(e){var n=e.player_name,t=e.player_id;return{id:t,name:n}});n(a)}).catch(function(e){r(e)})})}function s(a,o){return n(function(n,r){var s=t.get("nfToken");e.get("/api/t/"+a+"/matches/"+o+"?token="+s).then(function(e){var t=e.data,a=t.result,o={addedBy:a.added_by,id:a.match_id,tuh:a.tossups_heard,moderator:a.moderator,notes:a.notes,packet:a.packet,room:a.room,round:a.round,teams:a.teams.map(function(e){return{id:e.team_id,name:e.team_name,overtime:e.overtime_tossups,bouncebacks:e.bounceback_points,score:e.score,players:e.players.map(function(e){return{id:e.player_id,name:e.player_name,tuh:e.tossups_heard,points:e.tossup_values.reduce(function(e,n){return e[n.value]=n.number,e},{})}})}}),phases:a.phases.map(function(e){return{id:e.phase_id,name:e.phase_name}})};n(o)}).catch(function(e){return r(e)})})}function u(a,o,r){return n(function(n,s){var u={token:t.get("nfToken"),game:c(r)};e.put("/api/t/"+a+"/matches/"+o,u).then(function(e){var t=e.data,a=t.result;n(a)}).catch(function(e){return s(e)})})}function i(a,o){return n(function(n,r){var s=t.get("nfToken");e.delete("/api/t/"+a+"/matches/"+o+"?token="+s).then(function(e){var t=e.data,a=t.result.id;m(a),n()}).catch(function(e){return r(e)})})}function c(e){var n={};return angular.copy(e,n),n.phases=n.phases.map(function(e){return e.id}),n.teams=n.teams.map(function(e){return{id:e.teamInfo.id,score:e.score,bouncebacks:e.bouncebacks,overtime:e.overtime,players:e.players.map(function(e){return{id:e.id,tuh:e.tuh||0,points:Object.keys(e.points).map(Number).map(function(n){return{value:n,number:e.points[n]||0}})}})}}),n}function m(e){var n=l.gameFactory.games.findIndex(function(n){return n.id===e});n!==-1&&l.gameFactory.games.splice(n,1)}var l=this,d=[];return l.gameFactory={games:d,postGame:a,getGames:o,deleteGame:i,getTeamPlayers:r,getGameById:s,editGame:u},l.gameFactory}])}(),function(){angular.module("tournamentApp").factory("Phase",["$http","$q","Cookies","Tournament",function(e,n,t,a){function o(a,o){return n(function(n,r){var s={token:t.get("nfToken"),name:o};e.post("/api/t/"+a+"/phases",s).then(function(e){var t=e.data;l(t.result),1===f.phaseFactory.phases.length?i(a,t.result.id).then(function(){return n(t.result.name)}):n(t.result.name)}).catch(function(e){return r(e)})})}function r(a,o,r){return n(function(n,s){var u={token:t.get("nfToken"),newName:o};e.put("/api/t/"+a+"/phases/"+r,u).then(function(e){var t=e.data;m(t.result.id,t.result.name),n(t.result.name)}).catch(function(e){return s(e)})})}function s(a){return n(function(n,o){var r=t.get("nfToken");e.get("/api/t/"+a+"/phases?token="+r).then(function(e){var t=e.data,a=t.result.map(function(e){var n=e.name,t=e.id;return{name:n,newName:n,id:t}});angular.copy(a,f.phaseFactory.phases),n(a)}).catch(function(e){return o(e)})})}function u(a,o){return n(function(n,r){var s=t.get("nfToken");e.delete("/api/t/"+a+"/phases/"+o+"?token="+s).then(function(e){var t=e.data;d(t.result.id,a),f.phaseFactory.phases.length>0&&t.result.id===f.phaseFactory.activePhase.id?i(a,f.phaseFactory.phases[0].id).then(function(){return n(t.result.name)}):(c(null),n(t.result.name))}).catch(function(e){return r(e)})})}function i(a,o){return n(function(n,r){var s={token:t.get("nfToken")};e.put("/api/t/"+a+"/phases/"+o+"/active",s).then(function(e){var t=e.data;c(t.result.active_phase_id),n()}).catch(function(e){return r(e)})})}function c(e){var n=f.phaseFactory.phases.find(function(n){return n.id===e});f.phaseFactory.activePhase.id=n?n.id:null,f.phaseFactory.activePhase.name=n?n.name:null}function m(e,n){var t=f.phaseFactory.phases.findIndex(function(n){return n.id===e});t!==-1&&(f.phaseFactory.phases[t].name=n,f.phaseFactory.activePhase.id===e&&c(e))}function l(e){var n=e.name,t=e.id;f.phaseFactory.phases.push({name:n,id:t,newName:n})}function d(e,n){var t=f.phaseFactory.phases.findIndex(function(n){return n.id===e});t!==-1&&f.phaseFactory.phases.splice(t,1)}var f=this,p=[],h=a.activePhase;return f.phaseFactory={phases:p,postPhase:o,editPhase:r,getPhases:s,deletePhase:u,updateActivePhase:i,activePhase:h},f.phaseFactory}])}(),function(){angular.module("tournamentApp").factory("Team",["$http","$q","Cookies","Phase","Division",function(e,n,t,a,o){function r(a,o){return n(function(n,r){var u=p(o),i={team:u,token:t.get("nfToken")};e.post("/api/t/"+a+"/teams",i).then(function(e){var t=e.data;s(a),n(t.team.team.name)}).catch(function(e){return r(e)})})}function s(n){var a=t.get("nfToken");e.get("/api/t/"+n+"/teams?token="+a).then(function(e){var n=e.data,t=n.teams.map(function(e){var n=e.team_id,t=e.name,a=e.team_divisions,o=void 0===a?[]:a;return{id:n,name:t,divisions:null===o?{}:o.reduce(function(e,n){return e[n.phase_id]=n.division_id,e},{})}});angular.copy(t,y.teamFactory.teams)}).catch(function(e){return reject(e)})}function u(a,o){return n(function(n,r){var s=t.get("nfToken");e.get("/api/t/"+a+"/teams/"+o+"?token="+s).then(function(e){var t=e.data,a=t.result,o=a.name,r=a.id,s=a.players,u=a.team_divisions,i=a.added_by,c=a.games_count,m={name:o,newName:o,id:r,players:s.map(function(e){var n=e.player_name,t=e.player_id,a=e.added_by,o=e.games;return{name:n,newName:n,id:t,addedBy:a,games:o}}),mappedDivisions:u.reduce(function(e,n){return e[n.phase_id]=n.division_id,e},{}),addedBy:i,games:c};n(m)}).catch(function(e){return r(e)})})}function i(a,o,r){return n(function(n,s){var u={token:t.get("nfToken"),name:r};e.put("/api/t/"+a+"/teams/"+o,u).then(function(e){var t=e.data,a=t.result,o=a.id,r=a.name;h(o,r),n(r)}).catch(function(e){return s(e)})})}function c(a,o,r,s){return n(function(n,u){var i={token:t.get("nfToken"),divisions:s};e.put("/api/t/"+a+"/teams/"+o+"/divisions",i).then(function(e){e.data;g(o,r),n()}).catch(function(e){return u(e)})})}function m(a,o,r){return n(function(n,s){var u={token:t.get("nfToken"),name:r};e.put("/api/t/"+a+"/players/"+o,u).then(function(e){var t=e.data;n(t.result.name)}).catch(function(e){return s(e)})})}function l(a,o,r){return n(function(n,s){var u={token:t.get("nfToken"),name:r,team:o};e.post("/api/t/"+a+"/players",u).then(function(e){var t=e.data;return n(t.result)}).catch(function(e){return s(e)})})}function d(a,o){return n(function(n,r){var s=t.get("nfToken");e.delete("/api/t/"+a+"/players/"+o+"?token="+s).then(function(e){var t=e.data;return n(t.result.id)}).catch(function(e){return r(e)})})}function f(a,o){return n(function(n,r){var s=t.get("nfToken");e.delete("/api/t/"+a+"/teams/"+o+"?token="+s).then(function(e){var t=e.data;v(t.result.id),n()}).catch(function(e){return r(e)})})}function p(e){var n={};return n.players=e.players.filter(function(e){return e.name.trim().length>0}),n.name=e.name.trim(),n.divisions=Object.keys(e.divisions).map(function(n){return e.divisions[n].id}),n}function h(e,n){var t=y.teamFactory.teams.findIndex(function(n){return n.id===e});t!==-1&&(y.teamFactory.teams[t].name=n)}function g(e,n){var t=y.teamFactory.teams.findIndex(function(n){return n.id===e});t!==-1&&(y.teamFactory.teams[t].divisions=n)}function v(e){var n=y.teamFactory.teams.findIndex(function(n){return n.id===e});y.teamFactory.teams.splice(n,1)}var y=this,w=[];a.phases,o.divisions;return y.teamFactory={teams:w,postTeam:r,getTeams:s,getTeamById:u,deleteTeam:f,editTeamName:i,editTeamPlayerName:m,updateTeamDivisions:c,addPlayer:l,deletePlayer:d},y.teamFactory}])}(),function(){angular.module("tournamentApp").factory("Tournament",["$http","$q","Cookies",function(e,n,t){function a(a){return n(function(n,o){var r=t.get("nfToken");e.get("/api/t/"+a+"?token="+r).then(function(e){var t=e.data,a=t.data.tournament,o=t.data.permissions,r={tossupValues:a.tossup_point_scheme,partsPerBonus:a.parts_per_bonus,bonusPointValue:a.bonus_point_value},s={bouncebacks:a.bouncebacks,maxActive:a.max_active_players_per_team},u={id:a.active_phase_id,name:a.active_phase_name};angular.copy(u,i.tournamentFactory.activePhase),angular.copy(s,i.tournamentFactory.rules),angular.copy(r,i.tournamentFactory.pointScheme),n({tournamentInfo:{name:a.name,location:a.location,date:new Date(a.tournament_date),questionSet:a.question_set,comments:a.comments,hidden:a.hidden},tournamentContext:{admin:o.is_owner||o.is_admin,owner:o.is_owner||!1}})}).catch(function(e){o(e)})})}function o(a,o){return n(function(n,r){var s=t.get("nfToken"),u={token:s,location:o.location,name:o.name,date:o.date,questionSet:o.questionSet,comments:o.comments,hidden:o.hidden};e.put("/api/t/"+a,u).then(function(e){var t=e.data,a=t.result,o=a.name,r=a.location,s=a.hidden,u=a.comments,i=a.question_set,c=a.tournament_date,m={name:o,location:r,hidden:s,comments:u,questionSet:i,date:new Date(c)};n(m)}).catch(function(e){return r(e)})})}function r(a,o){var r=o.bouncebacks,s=o.maxActive;return n(function(n,o){var u=t.get("nfToken"),c={token:u,rules:{bouncebacks:r,maxActive:s}};e.put("/api/t/"+a+"/rules",c).then(function(e){var t=e.data,a={bouncebacks:t.result.bouncebacks,maxActive:t.result.max_active_players_per_team};angular.copy(a,i.tournamentFactory.rules),n(i.tournamentFactory.rules)}).catch(function(e){return o(e)})})}function s(a,o){var r=o.type,s=o.value;return n(function(n,o){var u=(t.get("nfToken"),{type:r,value:s});e.post("/api/t/"+a+"/pointscheme",u).then(function(e){var t=e.data;i.tournamentFactory.pointScheme.tossupValues.push({type:t.result.tossup_answer_type,value:t.result.tossup_value}),n({type:r,value:s})}).catch(function(e){return o(e)})})}function u(a,o){return n(function(n,r){var s=t.get("nfToken"),u={token:s,pointValues:o};e.put("/api/t/"+a+"/pointscheme",u).then(function(e){var t=e.data,a=t.result.tossupValues.map(function(e){var n=e.tossup_value,t=e.tossup_answer_type;return{value:n,type:t}}).sort(function(e,n){return e.value-n.value}),o={tossupValues:a,partsPerBonus:t.result.partsPerBonus,bonusPointValue:t.result.bonusPointValue};angular.copy(o,i.tournamentFactory.pointScheme),n()}).catch(function(e){return r(e)})})}var i=this,c={tossupValues:[]},m={},l={bouncebacks:!1,maxActive:4};return i.tournamentFactory={rules:l,activePhase:m,pointScheme:c,getTournamentContext:a,edit:o,addPointValue:s,postPointValues:u,updateRules:r},i.tournamentFactory}])}(),function(){angular.module("tournamentApp").factory("QBJ",["$http","$q","Cookies",function(e,n,t){function a(a,r){var s=r.download,u=void 0!==s&&s,i=r.fileName,c=void 0===i?"qbj_file":i;return n(function(n,r){var s=t.get("nfToken");e.get("/api/t/"+a+"/qbj?token="+s).then(function(e){var t=e.data;u&&o(t.result,c),n()}).catch(function(e){return r(e)})})}function o(e,n){if(window.navigator.msSaveOrOpenBlob){var t=[JSON.stringify(e,null,4)],a=new Blob(t);window.navigator.msSaveOrOpenBlob(a,n+".qbj")}else{var o;!function(){var t="json",a=new Blob([JSON.stringify(e,null,4)],{type:t}),r=window.URL||window.webkitURL,s=r.createObjectURL(a);o=document.createElement("a"),"undefined"==typeof o.download?window.location=s:(o.href=s,o.download=n+".qbj",document.body.appendChild(o),o.click(),setTimeout(function(){document.body.removeChild(o),window.URL.revokeObjectURL(s)},100))}()}}var r=this;return r.factory={getQBJReport:a},r.factory}])}(),function(){angular.module("statsApp").factory("Stats",["$http","$q","Cookies",function(e,n,t){function a(t){var a=arguments.length<=1||void 0===arguments[1]?null:arguments[1];return n(function(n,o){e.get("/api/t/"+t+"/stats/player"+(a?"?phase="+a:"")).then(function(e){var t=e.data;t.result.stats.forEach(function(e){e.pointMap=e.tossup_totals.reduce(function(e,n){return e[n.value]=n.total,e},{})}),angular.copy({id:t.result.activePhaseId},d.factory.activePhase),angular.copy(t.result.stats,d.factory.playerStats),angular.copy(t.result.pointScheme,d.factory.pointScheme),angular.copy({name:t.result.tournamentName},d.factory.tournamentName),n(t.result)}).catch(function(e){return o(e)})})}function o(t){var a=arguments.length<=1||void 0===arguments[1]?null:arguments[1];return n(function(n,o){e.get("/api/t/"+t+"/stats/team"+(a?"?phase="+a:"")).then(function(e){var t=e.data;t.result.stats.forEach(function(e){e.pointMap=e.tossup_totals.reduce(function(e,n){return e[n.value]=n.total,e},{})}),angular.copy(t.result.divisions,d.factory.divisions),angular.copy(t.result.stats,d.factory.teamStats),m(t.result.stats,t.result.divisions),n(t.result)}).catch(function(e){return o(e)})})}function r(t){var a=arguments.length<=1||void 0===arguments[1]?null:arguments[1];return n(function(n,o){e.get("/api/t/"+t+"/stats/teamfull"+(a?"?phase="+a:"")).then(function(e){var t=e.data;t.result.stats.forEach(function(e){e.matches.forEach(function(e){e.pointMap=e.tossup_totals.reduce(function(e,n){return e[n.value]=n.total,e},{})})}),angular.copy(t.result.stats,d.factory.teamFullStats),n()}).catch(function(e){return o(e)})})}function s(t){var a=arguments.length<=1||void 0===arguments[1]?null:arguments[1];return n(function(n,o){e.get("/api/t/"+t+"/stats/playerfull"+(a?"?phase="+a:"")).then(function(e){var t=e.data;t.result.stats.forEach(function(e){e.matches.forEach(function(e){e.pointMap=e.tossup_totals.reduce(function(e,n){return e[n.value]=n.total,e},{})})}),angular.copy(t.result.stats,d.factory.playerFullStats),n()}).catch(function(e){return o(e)})})}function u(t){var a=arguments.length<=1||void 0===arguments[1]?null:arguments[1];return n(function(n,o){e.get("/api/t/"+t+"/stats/roundreport"+(a?"?phase="+a:"")).then(function(e){var t=e.data;angular.copy(t.result.stats,d.factory.roundReportStats),n()}).catch(function(e){return o(e)})})}function i(a,o){var r=o.download,s=void 0!==r&&r,u=o.fileName,i=void 0===u?"qbj_file":u;return n(function(n,o){var r=t.get("nfToken");e.get("/api/t/"+a+"/qbj?token="+r).then(function(e){var t=e.data;s&&l(t.result,i),n()}).catch(function(e){return o(e)})})}function c(e,t){return n(function(i,c){n.all([a(e,t),o(e,t),r(e,t),s(e,t),u(e,t)]).then(function(){return i()}).catch(function(e){return c(e)})})}function m(e,n){var t=[];n.length>0&&(t=e.filter(function(e){return null===e.division_id})),angular.copy(t,d.factory.unassignedTeams)}function l(e,n){if(window.navigator.msSaveOrOpenBlob){var t=[JSON.stringify(e,null,4)],a=new Blob(t);window.navigator.msSaveOrOpenBlob(a,n+".qbj")}else{var o;!function(){var t="json",a=new Blob([JSON.stringify(e,null,4)],{type:t}),r=window.URL||window.webkitURL,s=r.createObjectURL(a);o=document.createElement("a"),"undefined"==typeof o.download?window.location=s:(o.href=s,o.download=n+".qbj",document.body.appendChild(o),o.click(),setTimeout(function(){document.body.removeChild(o),window.URL.revokeObjectURL(s)},100))}()}}var d=this;return d.factory={refreshStats:c,getQBJReport:i,playerStats:[],teamStats:[],teamFullStats:[],playerFullStats:[],roundReportStats:[],divisions:[],unassignedTeams:[],pointScheme:[],tournamentName:{},activePhase:{}},d.factory}])}();